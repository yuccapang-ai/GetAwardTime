<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ä¸€å¤©ä¸­æ¯åˆ†é’Ÿè·å¥–äººæ•°åˆ†å¸ƒï¼ˆå¯¹æ¯”ä¸¤å¤©ï¼‰</title>
    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background: #f5f7fb;
            color: #333;
        }
        .page-wrapper {
            min-height: 100vh;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 40px 16px;
        }
        .card {
            width: 100%;
            max-width: 1100px;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
            padding: 24px 28px 28px;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        .card-header-left h1 {
            margin: 0;
            font-size: 22px;
            font-weight: 600;
            color: #111827;
        }
        .card-header-left p {
            margin: 4px 0 0;
            font-size: 13px;
            color: #6b7280;
        }
        .card-header-right {
            text-align: right;
            font-size: 12px;
            color: #9ca3af;
        }
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .section-title span.tag {
            font-size: 11px;
            padding: 1px 6px;
            border-radius: 999px;
            background: #eef2ff;
            color: #4f46e5;
        }
        .textarea-wrapper {
            margin-top: 6px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            padding: 8px;
            transition: border-color 0.2s, box-shadow 0.2s, background 0.2s;
        }
        .textarea-wrapper:focus-within {
            border-color: #4f46e5;
            box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.25);
            background: #fff;
        }
        textarea {
            width: 100%;
            height: 160px;
            resize: vertical;
            border: none;
            outline: none;
            font-family: "JetBrains Mono", Consolas, "SFMono-Regular", Menlo, monospace;
            font-size: 12px;
            line-height: 1.4;
            background: transparent;
            color: #111827;
        }
        .example-box {
            font-size: 12px;
            color: #6b7280;
            background: #f3f4f6;
            border-radius: 8px;
            padding: 8px 10px;
            margin-top: 6px;
            white-space: pre-wrap;
            font-family: "JetBrains Mono", Consolas, monospace;
        }
        .control-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            margin-top: 12px;
            gap: 8px;
        }
        .btn-primary {
            border: none;
            outline: none;
            border-radius: 999px;
            padding: 8px 18px;
            font-size: 13px;
            font-weight: 500;
            background: linear-gradient(135deg, #4f46e5, #6366f1);
            color: #fff;
            cursor: pointer;
            box-shadow: 0 6px 16px rgba(79, 70, 229, 0.35);
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s;
        }
        .btn-primary:hover {
            filter: brightness(1.05);
            box-shadow: 0 8px 18px rgba(79, 70, 229, 0.45);
        }
        .btn-primary:active {
            transform: translateY(1px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
        }
        .btn-primary span.icon {
            font-size: 15px;
        }
        #msg {
            font-size: 12px;
        }
        #msg.error { color: #b91c1c; }
        #msg.ok { color: #16a34a; }
        .hint {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 4px;
        }
        .filters {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px 16px;
            font-size: 12px;
            align-items: center;
        }
        .filter-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .filter-item label {
            color: #4b5563;
        }
        .filter-item input[type="time"],
        .filter-item input[type="number"],
        .filter-item input[type="date"],
        .filter-item select {
            font-size: 12px;
            padding: 4px 6px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
        }
        #chartContainer {
            width: 100%;
            height: 800px;
            margin-top: 18px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            padding: 10px;
            background: radial-gradient(circle at top left, #eef2ff 0, #ffffff 40%);
        }
        @media (max-width: 768px) {
            .card {
                padding: 16px 14px 18px;
            }
            .card-header {
                flex-direction: column;
                gap: 6px;
            }
            .control-row {
                flex-direction: column;
                align-items: flex-start;
            }
            #chartContainer {
                height: 360px;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
<div class="page-wrapper">
    <div class="card">
        <div class="card-header">
            <div class="card-header-left">
                <h1>ä¸€å¤©ä¸­æ¯åˆ†é’Ÿè·å¥–äººæ•°åˆ†å¸ƒ</h1>
                <p>ç²˜è´´ time,roleidï¼ŒæŒ‰æ—¥æœŸ / æ—¶é—´æ®µ / ç²’åº¦ç»Ÿè®¡ï¼Œæ”¯æŒæŸ±çŠ¶å›¾ & æŠ˜çº¿å›¾ï¼Œä»¥åŠä¸¤å¤©å¯¹æ¯”ã€‚</p>
            </div>
            <div class="card-header-right">
                <div>æ—¶é—´ç»´åº¦ï¼šä¸€å¤©ä¸­çš„åˆ†é’Ÿï¼ˆå¯èšåˆï¼‰</div>
                <div>å›¾å½¢ï¼šçºµè½´ä¸ºæ—¶é—´ï¼ˆæˆ–æ—¶é—´æ®µï¼‰ï¼Œæ¨ªè½´ä¸ºè·å¥–æ¬¡æ•°</div>
            </div>
        </div>

        <div class="section-title">
            æ•°æ®è¾“å…¥
            <span class="tag">ç²˜è´´æ¨¡å¼</span>
        </div>
        <div class="example-box">
æ”¯æŒçš„ time æ ¼å¼ç¤ºä¾‹ï¼š
time,roleid
16:20,2045401754
13:33,1522960124
2026-02-02 02:37:14.000,1451304816
2026-02-03 18:01:03.500,1234567890
        </div>

        <div class="textarea-wrapper">
            <textarea id="inputArea" placeholder="åœ¨è¿™é‡Œç²˜è´´ time,roleid çš„è¡¨æ ¼å†…å®¹ï¼ˆæ”¯æŒ HH:MM æˆ– YYYY-MM-DD HH:MM:SS.sssï¼Œé€—å·æˆ– Tab/ç©ºæ ¼åˆ†éš”ï¼‰"></textarea>
        </div>
        <div class="hint">å¯ä»¥åŒ…å«è¡¨å¤´ï¼ˆä¾‹å¦‚ time,roleidï¼‰ã€‚</div>

        <div class="filters">
            <div class="filter-item">
                <label for="dateFilter">æ—¥æœŸï¼š</label>
                <input id="dateFilter" type="date">
                <span style="font-size:11px;color:#9ca3af;">ç•™ç©º=æ‰€æœ‰æ—¥æœŸæ±‡æ€»</span>
            </div>
            <div class="filter-item">
                <label for="compareDate">å¯¹æ¯”æ—¥æœŸï¼š</label>
                <input id="compareDate" type="date">
                <span style="font-size:11px;color:#9ca3af;">å¯é€‰ï¼Œç”¨äºç”»ç¬¬äºŒæ¡çº¿</span>
            </div>
            <div class="filter-item">
                <label for="startTime">èµ·å§‹æ—¶é—´ï¼š</label>
                <input id="startTime" type="time" value="00:00">
            </div>
            <div class="filter-item">
                <label for="endTime">ç»“æŸæ—¶é—´ï¼š</label>
                <input id="endTime" type="time" value="23:59">
            </div>
            <div class="filter-item">
                <label for="granularity">ç²’åº¦ï¼š</label>
                <input id="granularity" type="number" min="1" max="60" value="1" style="width:70px;">
                <span>åˆ†é’Ÿï¼ˆ1~60ï¼‰</span>
            </div>
            <div class="filter-item">
                <label for="chartType">å›¾è¡¨ç±»å‹ï¼š</label>
                <select id="chartType">
                    <option value="bar">æŸ±çŠ¶å›¾</option>
                    <option value="line" selected>æŠ˜çº¿å›¾</option>
                </select>
            </div>
        </div>

        <div class="control-row">
            <div>
                <button id="generateBtn" class="btn-primary">
                    <span class="icon">ğŸ“Š</span>
                    <span>ç”Ÿæˆå›¾è¡¨</span>
                </button>
            </div>
            <div id="msg"></div>
        </div>

        <div id="chartContainer">
            <canvas id="rewardChart"></canvas>
        </div>
    </div>
</div>

<script>
    const inputArea = document.getElementById('inputArea');
    const generateBtn = document.getElementById('generateBtn');
    const msg = document.getElementById('msg');
    const startTimeInput = document.getElementById('startTime');
    const endTimeInput = document.getElementById('endTime');
    const granularityInput = document.getElementById('granularity');
    const dateFilterInput = document.getElementById('dateFilter');
    const compareDateInput = document.getElementById('compareDate');
    const chartTypeSelect = document.getElementById('chartType');

    let chartInstance = null;

    generateBtn.addEventListener('click', () => {
        const text = inputArea.value.trim();
        if (!text) {
            setMsg('è¯·å…ˆç²˜è´´å†…å®¹ã€‚', 'error');
            return;
        }
        try {
            const data = parseTextToData(text);

            const startHHMM = startTimeInput.value || '00:00';
            const endHHMM = endTimeInput.value || '23:59';
            let stepMinutes = parseInt(granularityInput.value, 10) || 1;

            if (stepMinutes < 1 || stepMinutes > 60) {
                setMsg('ç²’åº¦å¿…é¡»åœ¨ 1~60 åˆ†é’Ÿä¹‹é—´ã€‚', 'error');
                return;
            }

            const startMinutes = hhmmToMinutes(startHHMM);
            const endMinutes = hhmmToMinutes(endHHMM);
            if (endMinutes < startMinutes) {
                setMsg('ç»“æŸæ—¶é—´ä¸èƒ½æ—©äºèµ·å§‹æ—¶é—´ã€‚', 'error');
                return;
            }

            const dateFilter = dateFilterInput.value || null;      // ä¸»æ—¥æœŸ
            const compareDate = compareDateInput.value || null;    // å¯¹æ¯”æ—¥æœŸ
            const chartType = chartTypeSelect.value || 'line';

            if (compareDate && dateFilter && compareDate === dateFilter) {
                setMsg('â€œæ—¥æœŸâ€å’Œâ€œå¯¹æ¯”æ—¥æœŸâ€ä¸èƒ½ç›¸åŒã€‚', 'error');
                return;
            }

            const options = {
                startMinutes,
                endMinutes,
                stepMinutes,
                dateFilter,
                compareDate,
                chartType
            };

            renderChartFromData(data, options);

            let dateText;
            if (dateFilter && compareDate) {
                dateText = `æ—¥æœŸ=${dateFilter} ä¸ å¯¹æ¯”æ—¥æœŸ=${compareDate}ï¼Œ`;
            } else if (dateFilter) {
                dateText = `æ—¥æœŸ=${dateFilter}ï¼Œ`;
            } else if (compareDate) {
                dateText = `å¯¹æ¯”æ—¥æœŸ=${compareDate}ï¼ˆä¸»çº¿ä¸ºæ‰€æœ‰æ—¥æœŸæ±‡æ€»ï¼‰ï¼Œ`;
            } else {
                dateText = 'æ‰€æœ‰æ—¥æœŸæ±‡æ€»ï¼Œ';
            }

            setMsg(
                `è§£ææˆåŠŸï¼Œè®°å½•æ•°ï¼š${data.length}ï¼Œ${dateText}æ—¶é—´æ®µ ${startHHMM} ~ ${endHHMM}ï¼Œç²’åº¦ ${stepMinutes} åˆ†é’Ÿã€‚`,
                'ok'
            );
        } catch (e) {
            console.error(e);
            setMsg('è§£æå¤±è´¥ï¼š' + e.message, 'error');
        }
    });

    function setMsg(text, type) {
        msg.textContent = text;
        msg.className = type === 'ok' ? 'ok' : (type === 'error' ? 'error' : '');
    }

    // "HH:MM" -> è· 00:00 çš„åˆ†é’Ÿæ•°
    function hhmmToMinutes(hhmm) {
        const [h, m] = hhmm.split(':').map(x => parseInt(x, 10) || 0);
        return h * 60 + m;
    }

    // index(0~1439) -> "HH:MM"
    function indexToHHMM(idx) {
        const h = Math.floor(idx / 60);
        const m = idx % 60;
        return String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
    }

    // è§£æç²˜è´´æ–‡æœ¬ -> { time, roleid }[]
    function parseTextToData(text) {
        const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
        if (lines.length === 0) {
            throw new Error('å†…å®¹ä¸ºç©º');
        }

        let startIndex = 0;
        let hasHeader = false;
        let headerCols = [];

        const firstLine = lines[0].trim();
        if (firstLine.toLowerCase().includes('time') && firstLine.toLowerCase().includes('role')) {
            hasHeader = true;
            startIndex = 1;
            headerCols = splitLine(firstLine);
        }

        const result = [];

        for (let i = startIndex; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;

            const cols = splitLine(line);
            if (cols.length < 2) continue;

            let time, roleid;

            if (hasHeader) {
                const colMap = {};
                headerCols.forEach((h, idx) => {
                    colMap[h.trim().toLowerCase()] = idx;
                });
                const tIdx = colMap['time'];
                const rIdx = colMap['roleid'];
                if (tIdx == null || rIdx == null) {
                    throw new Error('æ— æ³•æ ¹æ®è¡¨å¤´è¯†åˆ« time / roleid åˆ—');
                }
                time = cols[tIdx];
                roleid = cols[rIdx];
            } else {
                time = cols[0];
                roleid = cols[1];
            }

            time = String(time).trim();
            roleid = String(roleid).trim();
            if (!time) continue;

            result.push({ time, roleid });
        }

        if (result.length === 0) {
            throw new Error('æœªè§£æåˆ°ä»»ä½•æ•°æ®ï¼Œè¯·æ£€æŸ¥æ ¼å¼ã€‚');
        }

        return result;
    }

    // è¡Œåˆ†éš”ï¼šé€—å· > Tab > ç©ºæ ¼
    function splitLine(line) {
        if (line.includes(',')) {
            return line.split(',').map(s => s.trim());
        }
        if (line.includes('\t')) {
            return line.split('\t').map(s => s.trim());
        }
        return line.split(/\s+/).map(s => s.trim());
    }

    // ä» time å­—ç¬¦ä¸²æå– "YYYY-MM-DD"ï¼Œä¸å­˜åœ¨åˆ™è¿”å› null
    function extractDate(timeStr) {
        if (!timeStr) return null;
        timeStr = String(timeStr).trim();
        if (timeStr.includes(' ')) {
            const parts = timeStr.split(' ');
            const maybeDate = parts[0];
            if (/^\d{4}-\d{2}-\d{2}$/.test(maybeDate)) {
                return maybeDate;
            }
        }
        return null;
    }

    // ä» time å­—ç¬¦ä¸²æå– "HH:MM"
    function extractHHMM(timeStr) {
        if (!timeStr) return null;
        timeStr = String(timeStr).trim();

        let timePart = timeStr;
        if (timeStr.includes(' ')) {
            const parts = timeStr.split(' ');
            timePart = parts[1] || parts[0];
        }

        const tParts = timePart.split(':');
        if (tParts.length < 2) return null;

        let h = tParts[0];
        let m = tParts[1];

        if (m.includes('.')) {
            m = m.split('.')[0];
        }

        h = h.padStart(2, '0');
        m = m.padStart(2, '0');

        return `${h}:${m}`;
    }

    // èšåˆå¹¶ç”»å›¾ï¼šæ”¯æŒæ—¥æœŸè¿‡æ»¤ + å¯¹æ¯”æ—¥æœŸ + æ—¶é—´çª—å£ + ä»»æ„ç²’åº¦ + å›¾è¡¨ç±»å‹
    // èšåˆå¹¶ç”»å›¾ï¼šæ”¯æŒæ—¥æœŸè¿‡æ»¤ + å¯¹æ¯”æ—¥æœŸ + æ—¶é—´çª—å£ + ä»»æ„ç²’åº¦ + å›¾è¡¨ç±»å‹
function renderChartFromData(
    data,
    { startMinutes, endMinutes, stepMinutes, dateFilter, compareDate, chartType }
) {
    const countsAll = {};        // æ‰€æœ‰æ—¥æœŸæ±‡æ€»ï¼š key = åˆ†é’Ÿç´¢å¼•(0~1439)
    const countsByDate = {};     // æ¯ä¸ªå…·ä½“æ—¥æœŸï¼š countsByDate[date][idx] = æ¬¡æ•°

    // å…ˆç»Ÿè®¡æ‰€æœ‰æ•°æ®
    data.forEach(row => {
        const dateStr = extractDate(row.time); // å¯èƒ½ä¸º null
        const hhmm = extractHHMM(row.time);
        if (!hhmm) return;

        const idx = hhmmToMinutes(hhmm);

        // æ‰€æœ‰æ—¥æœŸçš„æ±‡æ€»
        countsAll[idx] = (countsAll[idx] || 0) + 1;

        // æŒ‰æ—¥æœŸç»Ÿè®¡
        if (dateStr) {
            if (!countsByDate[dateStr]) countsByDate[dateStr] = {};
            countsByDate[dateStr][idx] = (countsByDate[dateStr][idx] || 0) + 1;
        }
    });

    // å†³å®šä¸»æ›²çº¿å’Œå¯¹æ¯”æ›²çº¿å¯¹åº”çš„è®¡æ•°è¡¨
    let baseLabel;
    let baseCounts;
    let compareLabel = null;
    let compareCounts = null;

    if (dateFilter) {
        baseLabel = dateFilter;
        baseCounts = countsByDate[dateFilter] || {};
    } else {
        baseLabel = 'æ‰€æœ‰æ—¥æœŸæ±‡æ€»';
        baseCounts = countsAll;
    }

    if (compareDate && compareDate !== dateFilter) {
        compareLabel = compareDate;
        compareCounts = countsByDate[compareDate] || {};
    }

    const labels = [];
    const baseValues = [];
    const compareValues = [];

    // æŒ‰æ—¶é—´çª—å£ + ç²’åº¦èšåˆ
    for (let t = startMinutes; t <= endMinutes; t += stepMinutes) {
        const bandStart = t;
        const bandEnd = Math.min(t + stepMinutes, endMinutes + 1); // å³å¼€åŒºé—´

        let baseSum = 0;
        let compareSum = 0;

        for (let i = bandStart; i < bandEnd; i++) {
            if (baseCounts[i]) baseSum += baseCounts[i];
            if (compareCounts && compareCounts[i]) compareSum += compareCounts[i];
        }

        let label;
        if (stepMinutes === 1) {
            label = indexToHHMM(bandStart);
        } else {
            label = `${indexToHHMM(bandStart)} - ${indexToHHMM(bandEnd - 1)}`;
        }

        labels.push(label);
        baseValues.push(baseSum);
        if (compareCounts) compareValues.push(compareSum);
    }

    // é…è‰²
    const baseColor = 'rgba(79, 70, 229, 1)';          // ä¸»çº¿æ·±ç´«
    const baseBgBar = 'rgba(79, 70, 229, 0.9)';        // ä¸»æŸ±å®å¿ƒç´«
    const compareColor = 'rgba(16, 185, 129, 1)';      // å¯¹æ¯”çº¿ç»¿è‰²
    const compareBgBar = 'rgba(16, 185, 129, 0.9)';    // å¯¹æ¯”æŸ±å®å¿ƒç»¿

    const datasets = [];

    // ä¸»æ•°æ®é›†
    datasets.push({
        label: `${baseLabel}ï¼šæ¯${stepMinutes}åˆ†é’Ÿè·å¥–æ¬¡æ•°`,
        data: baseValues,
        backgroundColor: chartType === 'bar'
            ? baseBgBar
            : 'rgba(129, 140, 248, 0.15)',
        borderColor: baseColor,
        borderWidth: chartType === 'bar' ? 1 : 1.5,
        tension: 0.25,
        pointRadius: chartType === 'line' ? 1.5 : 0,
        fill: chartType === 'line'
    });

    // å¯¹æ¯”æ•°æ®é›†ï¼ˆå¦‚æœæœ‰ï¼‰
    if (compareCounts) {
        datasets.push({
            label: `${compareLabel}ï¼šæ¯${stepMinutes}åˆ†é’Ÿè·å¥–æ¬¡æ•°`,
            data: compareValues,
            backgroundColor: chartType === 'bar'
                ? compareBgBar
                : 'rgba(34, 197, 94, 0.15)',
            borderColor: compareColor,
            borderWidth: chartType === 'bar' ? 1 : 1.5,
            tension: 0.25,
            pointRadius: chartType === 'line' ? 1.5 : 0,
            fill: false
        });
    }

    const ctx = document.getElementById('rewardChart').getContext('2d');
    if (chartInstance) chartInstance.destroy();

    chartInstance = new Chart(ctx, {
        type: chartType,
        data: {
            labels,
            datasets
        },
        options: {
            indexAxis: 'y',  // çºµè½´ä¸ºæ—¶é—´ / æ—¶é—´æ®µ
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            scales: {
                y: {
                    title: {
                        display: true,
                        text: stepMinutes === 1
                            ? 'æ—¶é—´ï¼ˆåˆ†é’Ÿï¼ŒHH:MMï¼‰'
                            : `æ—¶é—´åŒºé—´ï¼ˆæ¯ ${stepMinutes} åˆ†é’Ÿï¼‰`
                    },
                    ticks: {
                        maxTicksLimit: 40
                    },
                    grid: {
                        display: chartType === 'bar' ? false : true
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'è·å¥–æ¬¡æ•°'
                    },
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(148, 163, 184, 0.3)'
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    labels: {
                        boxWidth: 12
                    }
                },
                tooltip: {
                    callbacks: {
                        title(items) {
                            return `æ—¶é—´ï¼š${items[0].label}`;
                        },
                        label(item) {
                            return `${item.dataset.label}ï¼š${item.formattedValue}`;
                        }
                    }
                }
            }
        }
    });
}

        
</script>
</body>
</html>
