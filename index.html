<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ä¸€å¤©ä¸­æ¯åˆ†é’Ÿè·å¥–äººæ•°åˆ†å¸ƒï¼ˆå¯¹æ¯”ä¸¤å¤©ï¼‰</title>
    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background: #f5f7fb;
            color: #333;
        }
        .page-wrapper {
            min-height: 100vh;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 40px 16px;
        }
        .card {
            width: 100%;
            max-width: 1100px;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
            padding: 24px 28px 28px;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        .card-header-left h1 {
            margin: 0;
            font-size: 22px;
            font-weight: 600;
            color: #111827;
        }
        .card-header-left p {
            margin: 4px 0 0;
            font-size: 13px;
            color: #6b7280;
        }
        .card-header-right {
            text-align: right;
            font-size: 12px;
            color: #9ca3af;
        }
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .section-title span.tag {
            font-size: 11px;
            padding: 1px 6px;
            border-radius: 999px;
            background: #eef2ff;
            color: #4f46e5;
        }
        .textarea-wrapper {
            margin-top: 6px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            padding: 8px;
            transition: border-color 0.2s, box-shadow 0.2s, background 0.2s;
        }
        .textarea-wrapper:focus-within {
            border-color: #4f46e5;
            box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.25);
            background: #fff;
        }
        textarea {
            width: 100%;
            height: 160px;
            resize: vertical;
            border: none;
            outline: none;
            font-family: "JetBrains Mono", Consolas, "SFMono-Regular", Menlo, monospace;
            font-size: 12px;
            line-height: 1.4;
            background: transparent;
            color: #111827;
        }
        .example-box {
            font-size: 12px;
            color: #6b7280;
            background: #f3f4f6;
            border-radius: 8px;
            padding: 8px 10px;
            margin-top: 6px;
            white-space: pre-wrap;
            font-family: "JetBrains Mono", Consolas, monospace;
        }
        .control-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            margin-top: 12px;
            gap: 8px;
        }
        .btn-primary {
            border: none;
            outline: none;
            border-radius: 999px;
            padding: 8px 18px;
            font-size: 13px;
            font-weight: 500;
            background: linear-gradient(135deg, #4f46e5, #6366f1);
            color: #fff;
            cursor: pointer;
            box-shadow: 0 6px 16px rgba(79, 70, 229, 0.35);
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s;
        }
        .btn-primary:hover {
            filter: brightness(1.05);
            box-shadow: 0 8px 18px rgba(79, 70, 229, 0.45);
        }
        .btn-primary:active {
            transform: translateY(1px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
        }
        .btn-primary span.icon {
            font-size: 15px;
        }
        #msg {
            font-size: 12px;
        }
        #msg.error { color: #b91c1c; }
        #msg.ok { color: #16a34a; }
        .hint {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 4px;
        }
        .filters {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px 16px;
            font-size: 12px;
            align-items: center;
        }
        .filter-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .filter-item label {
            color: #4b5563;
        }
        .filter-item input[type="time"],
        .filter-item input[type="number"],
        .filter-item input[type="date"],
        .filter-item select {
            font-size: 12px;
            padding: 4px 6px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
        }
        #chartContainer {
            width: 100%;
            max-height: 600px;
            margin-top: 18px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            padding: 10px;
            background: radial-gradient(circle at top left, #eef2ff 0, #ffffff 40%);
            overflow-y: auto;
        }
        /* ç´¯ç§¯æŠ•æ”¾ + æ—¶é—´è¿›åº¦ */
        #summaryContainer {
            margin-top: 16px;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            background: #ecfdf5;
            font-size: 12px;
            color: #166534;
        }
        /* æ—¶é—´æ®µè¡¨æ ¼ */
        #tableContainer {
            margin-top: 16px;
            max-height: 300px;
            overflow: auto;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            background: #ffffff;
            font-size: 12px;
        }
        #tableContainer table {
            width: 100%;
            border-collapse: collapse;
        }
        #tableContainer thead {
            background: #f3f4f6;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        #tableContainer th,
        #tableContainer td {
            padding: 6px 8px;
            border-bottom: 1px solid #e5e7eb;
            text-align: right;
        }
        #tableContainer th:first-child,
        #tableContainer td:first-child {
            text-align: left;
        }
        /* é‡å¤è·å¥–è§’è‰²åˆ—è¡¨ */
        #dupContainer {
            margin-top: 16px;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            font-size: 12px;
        }
        #dupContainer h3 {
            margin: 0 0 6px;
            font-size: 13px;
            font-weight: 600;
            color: #374151;
        }
        #dupContainer table {
            width: 100%;
            border-collapse: collapse;
        }
        #dupContainer th,
        #dupContainer td {
            padding: 4px 6px;
            border-bottom: 1px solid #e5e7eb;
            text-align: right;
        }
        #dupContainer th:first-child,
        #dupContainer td:first-child {
            text-align: left;
        }
        #dupContainer .dup-empty {
            font-size: 12px;
            color: #6b7280;
        }
        @media (max-width: 768px) {
            .card {
                padding: 16px 14px 18px;
            }
            .card-header {
                flex-direction: column;
                gap: 6px;
            }
            .control-row {
                flex-direction: column;
                align-items: flex-start;
            }
            #chartContainer {
                max-height: 360px;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
<div class="page-wrapper">
    <div class="card">
        <div class="card-header">
            <div class="card-header-left">
                <h1>ä¸€å¤©ä¸­æ¯åˆ†é’Ÿè·å¥–äººæ•°åˆ†å¸ƒ</h1>
                <p>ç²˜è´´ time,roleidï¼ŒæŒ‰æ—¥æœŸ / æ—¶é—´æ®µ / ç²’åº¦ç»Ÿè®¡ï¼Œæ”¯æŒæŸ±çŠ¶å›¾ & æŠ˜çº¿å›¾ï¼Œä»¥åŠä¸¤å¤©å¯¹æ¯”ã€‚</p>
            </div>
            <div class="card-header-right">
                <div>æ—¶é—´ç»´åº¦ï¼šä¸€å¤©ä¸­çš„åˆ†é’Ÿï¼ˆå¯èšåˆï¼‰</div>
                <div>å›¾å½¢ï¼šçºµè½´ä¸ºæ—¶é—´ï¼ˆæˆ–æ—¶é—´æ®µï¼‰ï¼Œæ¨ªè½´ä¸ºè·å¥–æ¬¡æ•°</div>
            </div>
        </div>

        <div class="section-title">
            æ•°æ®è¾“å…¥
            <span class="tag">ç²˜è´´æ¨¡å¼</span>
        </div>
        <div class="example-box">
æ”¯æŒçš„ time æ ¼å¼ç¤ºä¾‹ï¼š
time,roleid
16:20,2045401754
13:33,1522960124
2026-02-02 02:37:14.000,1451304816
2026-02-03 18:01:03.500,1234567890
        </div>

        <div class="textarea-wrapper">
            <textarea id="inputArea" placeholder="åœ¨è¿™é‡Œç²˜è´´ time,roleid çš„è¡¨æ ¼å†…å®¹ï¼ˆæ”¯æŒ HH:MM æˆ– YYYY-MM-DD HH:MM:SS.sssï¼Œé€—å·æˆ– Tab/ç©ºæ ¼åˆ†éš”ï¼‰"></textarea>
        </div>
        <div class="hint">å¯ä»¥åŒ…å«è¡¨å¤´ï¼ˆä¾‹å¦‚ time,roleidï¼‰ã€‚</div>

        <div class="filters">
            <div class="filter-item">
                <label for="dateFilter">æ—¥æœŸï¼š</label>
                <input id="dateFilter" type="date" value="2026-02-04">
                <span style="font-size:11px;color:#9ca3af;">ç•™ç©º=æ‰€æœ‰æ—¥æœŸæ±‡æ€»</span>
            </div>
            <div class="filter-item">
                <label for="compareDate">å¯¹æ¯”æ—¥æœŸï¼š</label>
                <input id="compareDate" type="date">
                <span style="font-size:11px;color:#9ca3af;">å¯é€‰ï¼Œç”¨äºç”»ç¬¬äºŒæ¡çº¿</span>
            </div>
            <div class="filter-item">
                <label for="startTime">èµ·å§‹æ—¶é—´ï¼š</label>
                <input id="startTime" type="time" value="00:00">
            </div>
            <div class="filter-item">
                <label for="endTime">ç»“æŸæ—¶é—´ï¼š</label>
                <input id="endTime" type="time" value="23:59">
            </div>
            <div class="filter-item">
                <label for="granularity">ç²’åº¦ï¼š</label>
                <input id="granularity" type="number" min="1" max="60" value="60" style="width:70px;">
                <span>åˆ†é’Ÿï¼ˆ1~60ï¼‰</span>
            </div>
            <div class="filter-item">
                <label for="chartType">å›¾è¡¨ç±»å‹ï¼š</label>
                <select id="chartType">
                    <option value="bar">æŸ±çŠ¶å›¾</option>
                    <option value="line" selected>æŠ˜çº¿å›¾</option>
                </select>
            </div>
        </div>

        <div class="control-row">
            <div>
                <button id="fillDemoBtn" class="btn-primary" style="margin-right:8px;">
                    <span class="icon">ğŸ“‹</span>
                    <span>å¡«å……ç¤ºä¾‹æ•°æ®</span>
                </button>
                <button id="generateBtn" class="btn-primary">
                    <span class="icon">ğŸ“Š</span>
                    <span>ç”Ÿæˆå›¾è¡¨</span>
                </button>
            </div>
            <div id="msg"></div>
        </div>

        <div id="chartContainer">
            <canvas id="rewardChart"></canvas>
        </div>

        <!-- ç´¯ç§¯æŠ•æ”¾ + æ—¶é—´è¿›åº¦ -->
        <div id="summaryContainer"></div>

        <!-- ä¸‹è½½æŒ‰é’® + æ—¶é—´æ®µè¡¨ -->
        <div style="margin-top: 12px; display:flex; justify-content: space-between; align-items: center; gap:8px;">
            <div style="font-size:12px; color:#6b7280;">æ—¶é—´æ®µ-è·å¥–æ¬¡æ•°è¡¨</div>
            <button id="downloadTableBtn" class="btn-primary" style="padding:4px 10px; font-size:11px; box-shadow:none;">
                <span class="icon">â¬‡</span>
                <span>ä¸‹è½½è¡¨æ ¼ï¼ˆCSVï¼‰</span>
            </button>
        </div>
        <div id="tableContainer"></div>

        <!-- é‡å¤è·å¥–è§’è‰²åˆ—è¡¨ -->
        <div id="dupContainer"></div>
    </div>
</div>

<script>
    const inputArea = document.getElementById('inputArea');
    const generateBtn = document.getElementById('generateBtn');
    const fillDemoBtn = document.getElementById('fillDemoBtn');
    const downloadTableBtn = document.getElementById('downloadTableBtn');
    const msg = document.getElementById('msg');
    const startTimeInput = document.getElementById('startTime');
    const endTimeInput = document.getElementById('endTime');
    const granularityInput = document.getElementById('granularity');
    const dateFilterInput = document.getElementById('dateFilter');
    const compareDateInput = document.getElementById('compareDate');
    const chartTypeSelect = document.getElementById('chartType');

    let chartInstance = null;
    // ç”¨äºå¯¼å‡ºè¡¨æ ¼çš„æ•°æ®
    let lastTableLabels = [];
    let lastTableBaseValues = [];
    let lastTableCompareValues = [];
    let lastTableBaseLabel = '';
    let lastTableCompareLabel = '';
    let lastTableStepMinutes = 1;

    // ç¤ºä¾‹æ•°æ®
    const demoData = `time	roleid
2026-02-07 23:58:50.000	1939939899
2026-02-08 13:46:12.000	2073826335
2026-02-08 13:52:53.000	2061675824
2026-02-08 12:16:51.000	1468676792
2026-02-08 15:29:57.000	1847930730
2026-02-08 15:42:21.000	1840402747
2026-02-08 14:04:59.000	1646163704
2026-02-08 14:07:17.000	1288252172
2026-02-06 13:07:42.000	1959139344
2026-02-06 13:10:12.000	1454143402
2026-02-06 14:16:43.000	1918532285
2026-02-05 13:42:53.000	1289358618
2026-02-05 13:44:48.000	1471007715
2026-02-06 12:44:32.000	1650460663
2026-02-07 12:36:01.000	1899787789
2026-02-05 00:06:16.000	2067842574
2026-02-06 12:14:12.000	1787758612
2026-02-06 12:15:49.000	1681361412
2026-02-06 12:10:07.000	1800251478
2026-02-04 14:21:33.000	1437008311
2026-02-04 12:40:40.000	1905069808
2026-02-05 03:50:22.000	1660752771
2026-02-05 11:22:33.000	1934175205
2026-02-08 13:06:33.000	2075197014
2026-02-08 13:04:10.000	2070923923
2026-02-08 13:02:00.000	794842538
2026-02-08 12:59:48.000	1716757668
2026-02-04 10:42:27.000	1641133154
2026-02-07 08:02:10.000	1332627363
2026-02-04 13:15:12.000	2034664879
2026-02-08 11:27:46.000	1904318050
2026-02-05 14:39:53.000	1538961376
2026-02-05 14:40:50.000	1642703829
2026-02-05 14:39:16.000	1386985033
2026-02-04 13:35:14.000	1615494810
2026-02-04 13:37:34.000	1764736778
2026-02-04 13:28:06.000	1467688063
2026-02-03 06:42:02.000	1721995311
2026-02-08 10:33:24.000	1501773478
2026-02-06 15:19:47.000	2074016052
2026-02-06 15:20:28.000	2073590581
2026-02-06 15:22:41.000	1699869882
2026-02-05 19:52:14.000	1785370028
2026-02-05 19:48:09.000	1881566512
2026-02-05 19:46:31.000	1810859614
2026-02-05 04:17:32.000	1761067197
2026-02-06 14:51:17.000	1836032797
2026-02-08 08:55:35.000	1617890884
2026-02-05 04:16:57.000	1724768201
2026-02-07 13:56:38.000	1638781674
2026-02-07 13:54:07.000	1932563542
2026-02-02 16:58:12.000	1659432035
2026-02-05 01:32:53.000	1888756459
2026-02-06 15:03:26.000	1886305813
2026-02-06 15:09:47.000	2073186993
2026-02-08 00:09:01.000	1698167832
2026-02-07 20:57:43.000	1527151266
2026-02-05 22:26:55.000	1840876743
2026-02-04 20:07:04.000	1579464535
2026-02-04 20:01:46.000	2043891913
2026-02-08 12:48:42.000	2028662273
2026-02-08 19:21:15.000	1784831689
2026-02-08 19:24:39.000	2067208680
2026-02-06 13:31:37.000	1721814814
2026-02-06 13:32:23.000	1895339468
2026-02-07 09:50:48.000	1680455034
2026-02-05 05:16:10.000	2069230361
2026-02-02 16:20:15.000	2045401754
2026-02-05 17:07:45.000	1797254547
2026-02-05 17:08:35.000	1696175870
2026-02-06 18:13:57.000	1542202555
2026-02-06 18:19:15.000	1684078336
2026-02-06 18:16:13.000	1402084330
2026-02-06 16:12:09.000	1883240567
2026-02-03 07:16:53.000	1768549811
2026-02-03 15:17:27.000	1731646159
2026-02-03 03:50:57.000	1368923365
2026-02-04 12:29:08.000	1798641933
2026-02-05 19:20:20.000	1469205105
2026-02-05 19:13:29.000	1490171619
2026-02-07 15:12:04.000	1820965719
2026-02-04 16:19:39.000	2061500457
2026-02-08 18:03:55.000	1835579798
2026-02-08 17:31:42.000	2068743224
2026-02-03 01:03:20.000	1938021624
2026-02-03 01:02:17.000	1760451548
2026-02-08 16:29:25.000	2017265849
2026-02-08 16:31:13.000	1541396657
2026-02-02 19:15:00.000	1911247698
2026-02-02 19:19:23.000	1541501534
2026-02-03 06:55:06.000	2069713420
2026-02-05 02:27:59.000	1433295615
2026-02-05 02:34:12.000	2044885660
2026-02-03 18:06:35.000	1919821869
2026-02-08 01:20:59.000	1508744124
2026-02-07 13:18:46.000	1662892039
2026-02-08 19:15:47.000	1460657265
2026-02-08 19:12:54.000	2054759736
2026-02-05 10:30:25.000	1580636775
2026-02-06 17:06:25.000	1805742617
2026-02-06 17:11:46.000	1912329177
2026-02-08 02:29:33.000	1922199114
2026-02-05 04:17:37.000	1637308465
2026-02-06 01:50:37.000	2001355185
2026-02-03 19:04:04.000	1676302743
2026-02-03 21:31:39.000	1920913493
2026-02-03 15:05:11.000	1947159311
2026-02-04 19:44:09.000	1751067178
2026-02-05 14:49:03.000	1956593357
2026-02-05 14:51:38.000	1838380466
2026-02-04 15:10:13.000	1521407436
2026-02-04 15:14:41.000	1704908911
2026-02-04 15:10:22.000	1771105907
2026-02-05 07:13:09.000	1463885398
2026-02-05 06:34:17.000	2057940111
2026-02-06 22:19:04.000	1920331020
2026-02-06 22:23:58.000	2072228430
2026-02-08 22:45:43.000	1516774406
2026-02-07 10:11:58.000	1670002093
2026-02-05 00:31:12.000	1493553412
2026-02-05 00:30:53.000	1994474567
2026-02-03 10:45:53.000	1737114945
2026-02-04 16:41:30.000	1708261742
2026-02-03 19:17:10.000	1881229191
2026-02-04 08:26:21.000	1330891088
2026-02-06 20:50:34.000	1643534039
2026-02-04 11:27:22.000	1656566564
2026-02-02 03:42:51.000	1448887042
2026-02-05 16:33:05.000	1796058752
2026-02-07 15:39:45.000	1832800720
2026-02-07 15:41:29.000	2069463587
2026-02-07 15:50:39.000	1889462503
2026-02-02 02:36:47.000	1747073145
2026-02-04 16:21:35.000	1906349968
2026-02-07 10:35:18.000	2072697284
2026-02-02 21:20:47.000	2017148959
2026-02-02 21:19:37.000	2063800322
2026-02-02 03:15:31.000	823877375
2026-02-02 03:15:06.000	1679758585
2026-02-05 22:21:19.000	1728399800
2026-02-05 22:22:52.000	1894170248
2026-02-08 08:52:00.000	2075327337
2026-02-07 14:54:28.000	1686078385
2026-02-03 20:48:00.000	1946663096
2026-02-04 16:48:24.000	1826397767
2026-02-04 16:39:49.000	1390116046
2026-02-05 01:22:17.000	2040528626
2026-02-07 07:23:30.000	1331922656
2026-02-06 00:20:32.000	1898086678
2026-02-05 16:21:14.000	1448668914
2026-02-08 02:59:35.000	1698935798
2026-02-04 03:55:01.000	1505342405
2026-02-02 21:12:46.000	1270782388
2026-02-03 18:37:22.000	1374219859
2026-02-06 01:47:23.000	1721628240
2026-02-06 08:43:36.000	1405474975
2026-02-08 15:03:25.000	1511653775
2026-02-06 05:47:08.000	1822874239
2026-02-03 21:55:44.000	1942072860
2026-02-03 22:02:24.000	1901239486
2026-02-02 05:27:42.000	1410104394
2026-02-03 07:08:02.000	2064757339
2026-02-03 07:05:23.000	1682949639
2026-02-03 07:04:53.000	2071823166
2026-02-03 06:09:26.000	2046692386
2026-02-02 17:22:00.000	2069543553
2026-02-08 20:08:26.000	1919438644
2026-02-08 20:11:15.000	1541242325
2026-02-07 15:29:16.000	1918374877
2026-02-08 17:38:11.000	2065874698
2026-02-04 19:37:26.000	1776064008
2026-02-07 06:55:55.000	2009760689
2026-02-06 23:52:15.000	1900991362
2026-02-04 18:06:50.000	2022340837
2026-02-04 21:20:10.000	1840533705
2026-02-03 18:50:19.000	1906588215
2026-02-03 19:01:07.000	1769578502
2026-02-02 18:36:25.000	2064442628
2026-02-06 16:33:30.000	1334167124
2026-02-06 16:39:54.000	1786272152
2026-02-03 22:41:12.000	1894803420
2026-02-03 22:47:22.000	1715321814
2026-02-02 03:22:18.000	1919897307
2026-02-02 03:25:39.000	1484461954
2026-02-02 03:29:09.000	2056244153
2026-02-02 03:31:18.000	1466950722
2026-02-02 02:41:10.000	1933679215
2026-02-02 02:40:39.000	1261949569
2026-02-05 07:07:34.000	1282223357
2026-02-03 01:13:36.000	2070953722
2026-02-05 03:35:20.000	1507275132
2026-02-06 05:16:37.000	2073497880
2026-02-06 21:25:05.000	2073339881
2026-02-06 21:25:32.000	1415149765
2026-02-08 10:20:29.000	1537878323
2026-02-07 04:12:00.000	1698079271
2026-02-05 07:00:10.000	1846729473
2026-02-04 19:24:47.000	1922020422
2026-02-06 01:31:07.000	2068306725
2026-02-06 08:50:38.000	18417012
2026-02-02 23:02:18.000	1813627528
2026-02-07 06:06:27.000	1800316189
2026-02-03 06:25:19.000	1682077786
2026-02-05 09:22:10.000	1791671321
2026-02-08 21:54:37.000	1637631861
2026-02-08 21:59:20.000	1700427360
2026-02-04 17:07:54.000	1828033239
2026-02-04 17:13:23.000	1870771383
2026-02-07 04:30:05.000	2068294430
2026-02-02 13:33:14.000	1522960124
2026-02-02 23:07:37.000	755904204
2026-02-04 09:08:26.000	1710435572
2026-02-05 19:35:19.000	1720490944
2026-02-06 17:44:24.000	1947912865
2026-02-05 08:47:27.000	1326235199
2026-02-08 07:01:21.000	1848969080
2026-02-08 11:39:14.000	1735974159
2026-02-06 09:17:00.000	1508812793
2026-02-05 23:37:00.000	1850521618
2026-02-07 21:58:24.000	1951220383
2026-02-02 05:12:58.000	829172084
2026-02-08 06:37:46.000	1801562422
2026-02-04 07:22:31.000	1438704758
2026-02-04 04:14:02.000	2066356629
2026-02-03 19:22:37.000	1658571179
2026-02-03 19:30:50.000	1443413660
2026-02-07 05:16:53.000	1694998191
2026-02-08 01:54:56.000	2074994673
2026-02-05 16:10:27.000	2072091176
2026-02-05 16:05:26.000	1829748098
2026-02-04 18:43:52.000	1761025893
2026-02-02 17:10:07.000	1645579294
2026-02-08 07:29:27.000	1660812214
2026-02-04 04:09:20.000	1585353465
2026-02-04 09:55:34.000	2072268589
2026-02-04 09:54:53.000	2030404229
2026-02-02 19:54:32.000	1899922846
2026-02-05 01:14:57.000	1763666575
2026-02-07 20:30:48.000	2065025165
2026-02-04 19:10:20.000	1689426083
2026-02-07 19:04:19.000	1958176390
2026-02-02 23:29:59.000	1627319199
2026-02-04 03:22:36.000	1340501926
2026-02-08 02:07:07.000	806206956
2026-02-05 00:30:50.000	1888104023
2026-02-07 19:12:28.000	1668132092
2026-02-02 03:57:37.000	1463810346
2026-02-05 03:05:18.000	1355571784
2026-02-04 09:20:31.000	2057448017
2026-02-06 18:28:15.000	1676964485
2026-02-03 03:53:34.000	1957897023
2026-02-06 02:52:16.000	1707855794
2026-02-05 01:45:14.000	1797450495
2026-02-05 21:59:00.000	1435788596
2026-02-03 06:06:22.000	1328684060
2026-02-08 01:06:05.000	1850770023
2026-02-02 17:27:27.000	1451304816
2026-02-03 02:24:59.000	1808839592
2026-02-05 17:44:37.000	1405039714
2026-02-02 04:13:31.000	1411527591
2026-02-08 18:56:04.000	1499143428
2026-02-03 19:37:47.000	1726210900
2026-02-03 05:22:01.000	1750548230
2026-02-04 07:49:52.000	1758213994
2026-02-02 05:13:12.000	1870598124
2026-02-08 23:11:57.000	1489664118
2026-02-08 23:16:41.000	1414635807
2026-02-03 09:43:58.000	1732058358
2026-02-04 04:37:40.000	1844914610
2026-02-05 09:41:03.000	1635322117
2026-02-05 09:44:07.000	1517574620
2026-02-06 15:50:50.000	1771569627
2026-02-06 15:49:32.000	1779731341
2026-02-04 21:06:45.000	1447102139
2026-02-04 21:07:52.000	1846960154
2026-02-02 03:55:21.000	2055523844
2026-02-02 22:31:36.000	2023023372
2026-02-02 22:22:50.000	1976167120
2026-02-02 03:53:53.000	1831778330
2026-02-02 03:46:42.000	1782124339
2026-02-02 03:46:59.000	1457713696
2026-02-02 03:46:30.000	2066698137
2026-02-02 03:52:39.000	1743426511
2026-02-08 02:19:30.000	1748833462
2026-02-08 02:11:32.000	1731365933
2026-02-07 18:50:35.000	1685460840
2026-02-07 18:56:36.000	1440261921
2026-02-03 10:33:00.000	2037301604
2026-02-07 06:06:58.000	1769778740
2026-02-08 10:04:15.000	1490311299
2026-02-06 07:23:04.000	1801350929
2026-02-04 06:15:55.000	2053643147
2026-02-04 06:14:48.000	1257041897
2026-02-02 18:20:50.000	1697033841
2026-02-05 20:58:20.000	1414998735
2026-02-05 08:04:35.000	1149773583
2026-02-07 17:10:42.000	1326097482
2026-02-04 23:16:24.000	1974599972
2026-02-04 23:15:26.000	1932276375
2026-02-02 04:20:49.000	2069673586
2026-02-05 18:36:20.000	1326321323
2026-02-05 18:38:47.000	1884881736
2026-02-03 04:00:39.000	1998297096
2026-02-02 02:18:36.000	1869052745
2026-02-02 02:25:17.000	1872523104
2026-02-02 02:22:26.000	1700833210
2026-02-07 20:51:43.000	1711115467
2026-02-02 06:51:41.000	1713762799
2026-02-07 22:40:21.000	1825234831
2026-02-06 06:35:02.000	1260067511
2026-02-03 18:03:04.000	1774898987
2026-02-03 23:40:39.000	1664973535
2026-02-05 00:20:17.000	1776830809
2026-02-07 19:25:35.000	1396755290
2026-02-08 14:22:14.000	1750888417
2026-02-04 06:36:39.000	1754702175
2026-02-03 17:40:23.000	1884913241
2026-02-03 01:46:16.000	1288198619
2026-02-05 04:40:19.000	1957696392
2026-02-08 22:19:12.000	1814296478
2026-02-08 22:15:37.000	1874094817
2026-02-07 03:27:59.000	1942618950
2026-02-06 04:25:45.000	1561153345
2026-02-03 04:44:39.000	1675611461
2026-02-05 05:07:59.000	1773544673
2026-02-08 03:36:02.000	1557390722
2026-02-04 02:23:22.000	1493913559
2026-02-07 04:36:16.000	1953084684
2026-02-02 02:58:04.000	1928446205
2026-02-02 02:58:40.000	1666085463
2026-02-02 03:04:55.000	767625706
2026-02-02 03:05:50.000	2030302332
2026-02-03 22:22:14.000	1888239878
2026-02-06 07:25:45.000	1712080484
2026-02-07 17:47:10.000	1912119520
2026-02-07 16:27:02.000	1542824960
2026-02-05 02:30:03.000	1538105049
2026-02-08 00:50:39.000	788425283
2026-02-04 17:37:05.000	1940613823
2026-02-02 02:09:40.000	2065032776
2026-02-02 02:11:03.000	1876457350
2026-02-02 02:09:31.000	1393816662
2026-02-02 03:27:56.000	1434088255
2026-02-02 03:21:34.000	1936087805
2026-02-04 02:37:47.000	1785644425
2026-02-07 22:12:59.000	1410603079
2026-02-04 18:16:03.000	1501044983
2026-02-03 23:25:16.000	1647624453
2026-02-07 02:02:15.000	1575832356
2026-02-02 03:34:55.000	1321907309
2026-02-02 03:40:28.000	2062460012
2026-02-02 03:39:28.000	1924024565
2026-02-02 20:17:26.000	651134614
2026-02-06 04:11:40.000	1868254625
2026-02-05 07:35:52.000	1690635094
2026-02-06 00:05:08.000	1471925969
2026-02-06 01:18:21.000	1248078204
2026-02-06 01:21:08.000	1685838664
2026-02-07 00:14:04.000	2056364191
2026-02-02 03:01:15.000	1697404236
2026-02-02 03:02:30.000	1662062106
2026-02-02 03:07:33.000	1856972367
2026-02-02 02:59:52.000	1769666405
2026-02-02 02:58:38.000	1807093398
2026-02-02 03:00:47.000	1849681272
2026-02-02 03:30:49.000	2063962931
2026-02-02 03:29:25.000	1875464338
2026-02-02 03:29:51.000	1760783534
2026-02-02 03:29:30.000	1522118469
2026-02-02 03:28:21.000	1482615432
2026-02-04 23:29:56.000	2040408210
2026-02-04 23:00:22.000	1486877257
2026-02-04 23:00:43.000	1911518606
2026-02-06 19:59:11.000	1956680870
2026-02-06 20:01:57.000	1379061126
2026-02-06 20:07:48.000	1676047835
2026-02-02 03:12:18.000	1913697389
2026-02-02 03:15:34.000	2062148318
2026-02-02 03:13:37.000	2001926919
2026-02-02 03:14:11.000	1255402835
2026-02-04 03:09:53.000	1891315242
2026-02-07 03:26:04.000	1722989673
2026-02-07 00:18:09.000	1515774572
2026-02-07 00:17:42.000	1369599380
2026-02-04 00:57:43.000	1521067340
2026-02-06 22:13:37.000	2065084825
2026-02-04 21:34:56.000	1715798353
2026-02-07 21:30:13.000	1910931374
2026-02-07 21:29:50.000	1888393019
2026-02-07 01:15:52.000	1362264593
2026-02-07 01:15:59.000	2066156802
2026-02-02 21:05:03.000	1933285192
2026-02-02 02:36:13.000	1494170771
2026-02-02 02:37:14.000	2070815675
2026-02-08 04:05:54.000	1504385621
2026-02-07 07:31:58.000	2058279478
2026-02-07 06:32:59.000	1671634824
2026-02-03 21:06:23.000	1670351636
2026-02-02 02:04:41.000	1827753263
2026-02-02 03:50:12.000	1937270369
2026-02-04 07:04:20.000	2065217713
2026-02-02 05:08:45.000	1771880068
2026-02-02 08:32:07.000	1293684679
2026-02-03 22:12:59.000	1282651210
2026-02-03 22:08:23.000	2029339040
2026-02-03 22:15:49.000	1668794744
2026-02-02 21:47:48.000	1725687405
2026-02-02 06:36:35.000	1788956398
2026-02-07 17:30:03.000	1920242746
2026-02-07 17:29:57.000	1964436577
2026-02-05 23:51:05.000	1408564735
2026-02-05 23:46:34.000	1827942338
2026-02-05 23:49:51.000	2071698571
2026-02-04 07:15:18.000	1262744648
2026-02-02 18:48:13.000	1668009785
2026-02-02 18:56:53.000	1449066764
2026-02-03 22:58:53.000	2066666692
2026-02-03 22:53:15.000	2070230419
2026-02-03 22:58:25.000	1732199109
2026-02-03 07:54:40.000	2003962554
2026-02-07 03:42:05.000	1363815157
2026-02-08 02:44:21.000	1676589976
2026-02-04 10:19:58.000	2064351093
2026-02-08 00:27:46.000	1822916266
2026-02-02 01:58:41.000	1395285932
2026-02-02 02:04:42.000	1654207327
2026-02-08 00:11:20.000	1656334734
2026-02-07 23:41:13.000	1670452958
2026-02-04 20:22:28.000	1786118000
2026-02-04 20:26:13.000	1640871940
2026-02-06 02:22:32.000	1404405141
2026-02-04 14:02:47.000	2063587512
2026-02-04 14:06:59.000	1958145576
2026-02-08 14:43:04.000	1425440611
2026-02-06 04:59:06.000	1513403303
2026-02-08 05:36:11.000	1872999644
2026-02-06 04:25:14.000	1845205497
2026-02-06 20:27:48.000	1849863452
2026-02-06 00:53:52.000	2035169269
2026-02-06 19:08:54.000	2001925613
2026-02-08 05:23:27.000	1955056523
2026-02-02 23:40:26.000	1688103345
2026-02-02 23:46:45.000	1865847739
2026-02-08 15:55:20.000	1678663660
2026-02-08 15:53:43.000	2030717912
2026-02-08 15:51:47.000	2028115141
2026-02-02 02:52:43.000	1496147681
2026-02-03 08:32:51.000	1774963282
2026-02-05 02:42:46.000	1640339464
2026-02-02 02:41:22.000	2008010854
2026-02-06 05:57:02.000	1676064525
2026-02-05 12:04:55.000	1697040773
2026-02-04 22:15:09.000	1691437624
2026-02-08 00:27:19.000	1945098474
2026-02-07 08:37:20.000	1892066870
2026-02-02 05:28:01.000	1715295594
2026-02-08 14:52:40.000	1742354886
2026-02-04 22:05:49.000	587226423
2026-02-02 06:02:33.000	1441439186
2026-02-05 03:20:34.000	1656700805
2026-02-06 23:09:29.000	2071822618
2026-02-06 23:17:00.000	1387378274
2026-02-05 21:40:26.000	2038360613
2026-02-05 20:25:27.000	1909905690
2026-02-05 20:15:01.000	1483912898
2026-02-04 08:28:40.000	1669799313
2026-02-02 02:19:10.000	1968215016
2026-02-02 02:19:42.000	1643607534
2026-02-04 05:34:13.000	2067259478
2026-02-06 09:49:07.000	2071836311
2026-02-06 09:54:25.000	1495156242
2026-02-08 14:27:48.000	1944267085
2026-02-04 21:45:13.000	1876727650
2026-02-03 04:57:01.000	1511354239
2026-02-02 03:36:57.000	1673667710
2026-02-02 03:32:41.000	1928947583
2026-02-02 03:35:48.000	1467963182
2026-02-07 19:51:25.000	1299342597
2026-02-08 15:28:09.000	1701881166
2026-02-05 14:21:45.000	1958126406
2026-02-08 05:23:38.000	1842759526
2026-02-08 05:13:16.000	1669822747
2026-02-04 12:58:33.000	1667652482
2026-02-04 13:03:51.000	1432944247
2026-02-04 05:03:53.000	1710054924
2026-02-05 12:55:08.000	1658301590
2026-02-06 11:28:13.000	1632617605
2026-02-08 18:41:35.000	1660857608
2026-02-08 08:00:57.000	1866750967
2026-02-08 11:57:17.000	1452801575
2026-02-05 14:55:54.000	1700871148
2026-02-05 15:00:21.000	2056913507
2026-02-08 17:03:50.000	1696524575
2026-02-04 14:58:20.000	1871798328
2026-02-08 16:36:25.000	2064168673
2026-02-05 11:58:32.000	1653435169
2026-02-06 04:34:47.000	1285216099
2026-02-07 14:44:32.000	1297803523
2026-02-04 12:48:48.000	1654946024
2026-02-08 07:03:58.000	1833288834
2026-02-06 13:37:58.000	1680426140
2026-02-08 21:15:22.000	1650543006
2026-02-06 09:30:46.000	1697817590
2026-02-06 20:53:18.000	1842824881
2026-02-07 12:17:08.000	1819570906
2026-02-07 12:18:45.000	1672501647
2026-02-05 15:52:57.000	1806046994
2026-02-08 22:27:40.000	1871957771
2026-02-05 16:16:28.000	1788442253
2026-02-05 05:53:37.000	1892525864
2026-02-08 21:29:42.000	1335098712
2026-02-06 03:23:36.000	1889613077
2026-02-07 13:44:03.000	2072907196
2026-02-04 08:44:57.000	1938297270
2026-02-07 14:24:31.000	774987960
2026-02-06 13:58:26.000	1796610249
2026-02-04 10:48:35.000	1671504021
2026-02-06 16:05:00.000	1707340864
2026-02-07 09:20:05.000	2069173403
2026-02-06 16:55:01.000	1892800304
2026-02-08 09:06:59.000	2025436638
2026-02-08 20:13:39.000	1638880228
2026-02-04 16:07:13.000	1291726008
2026-02-07 22:29:42.000	1918731456
2026-02-07 09:20:59.000	1331273279
2026-02-08 19:31:15.000	1449562956
2026-02-08 19:39:13.000	1404657486
2026-02-05 23:15:30.000	1729716374
2026-02-06 10:52:32.000	2022062178
2026-02-06 03:07:47.000	1732168409
2026-02-08 05:03:26.000	1932321212
2026-02-04 04:40:03.000	1424068270
2026-02-07 11:41:35.000	2062242033
2026-02-07 20:16:09.000	1838754911
2026-02-08 21:22:01.000	1860714389
2026-02-05 11:47:34.000	821615052
2026-02-07 12:47:51.000	1726020147
2026-02-05 12:28:21.000	643767301
2026-02-05 12:30:32.000	1777401458
2026-02-05 12:31:08.000	1930917666
2026-02-05 12:27:54.000	1808819594
2026-02-05 12:31:24.000	2069816287
2026-02-06 18:43:35.000	1754764375
2026-02-06 02:34:05.000	1399304894
2026-02-06 03:24:09.000	1289177856
2026-02-07 20:12:32.000	1732130834
2026-02-04 06:27:50.000	1930488623
2026-02-07 16:42:32.000	1872290393
2026-02-08 07:35:10.000	1320941550
2026-02-06 06:17:26.000	2059236945
2026-02-08 06:06:34.000	1719605123
2026-02-07 08:03:45.000	1865343184
2026-02-08 04:25:15.000	1459779867
2026-02-05 18:14:05.000	1829522545
2026-02-06 19:12:26.000	1924989158
2026-02-06 19:17:09.000	1493595120
2026-02-04 05:41:23.000	1651296390
2026-02-05 05:39:12.000	1911200427
2026-02-04 02:52:59.000	2063472413
2026-02-04 01:43:46.000	1881425603
2026-02-08 07:05:20.000	1742803469
2026-02-04 01:57:42.000	1773949163
2026-02-07 11:27:33.000	1398098365
2026-02-06 22:29:53.000	1910679174
2026-02-04 00:42:09.000	1732159189
2026-02-05 10:44:26.000	2071390281
2026-02-05 10:47:00.000	1910525488
2026-02-05 10:43:54.000	2065127595
2026-02-06 10:39:29.000	2036359153
2026-02-06 10:40:49.000	1313325078
2026-02-06 10:35:24.000	1734085252
2026-02-08 08:12:02.000	1637326196
2026-02-04 02:02:32.000	2071916475
2026-02-06 00:49:42.000	1921240203
2026-02-04 18:22:23.000	1335976039
2026-02-07 04:53:52.000	1948204535
2026-02-07 03:09:07.000	1280438870
2026-02-06 07:26:03.000	1907752023
2026-02-06 22:53:01.000	1429742267
2026-02-08 03:24:40.000	1787890206
2026-02-08 03:24:35.000	1923806370
2026-02-06 05:33:27.000	1773583864
2026-02-06 10:47:49.000	1771301128
2026-02-07 05:48:28.000	1746233228
2026-02-04 00:40:56.000	1699386364
2026-02-04 00:48:06.000	1718639642
2026-02-04 00:44:22.000	1642710920
2026-02-05 06:33:40.000	2063539455
2026-02-05 06:33:17.000	1885388971
2026-02-07 15:55:38.000	1709012415
2026-02-05 05:30:32.000	1297777884
2026-02-07 11:01:19.000	1697820020
2026-02-07 01:35:54.000	1888844557
2026-02-07 01:34:40.000	2064530000
2026-02-05 18:23:07.000	1643499474
2026-02-07 15:03:51.000	1876806803
2026-02-07 15:07:04.000	1727103733
2026-02-07 15:10:58.000	1755984395
2026-02-07 23:53:36.000	1653674085
2026-02-07 05:12:54.000	1731063602
2026-02-08 07:57:10.000	1375335880
2026-02-08 23:01:39.000	1845138725
2026-02-08 22:59:19.000	2067248072
2026-02-06 23:26:48.000	1973745470
2026-02-05 17:15:43.000	1676245520
2026-02-07 00:05:01.000	1821283384
2026-02-06 07:56:38.000	1934127396
2026-02-04 03:58:55.000	1676498107
2026-02-07 07:09:57.000	1873854963
2026-02-07 23:15:03.000	1678063259
2026-02-04 01:17:07.000	1985841727
2026-02-05 17:56:06.000	801427242
2026-02-07 17:36:15.000	2067761033
2026-02-06 08:33:01.000	1805356893
2026-02-07 10:46:09.000	1238894995
2026-02-07 10:48:58.000	1254430235
2026-02-05 22:03:26.000	1785685933
2026-02-05 22:10:59.000	1839588054
2026-02-06 00:37:37.000	1842601870
2026-02-05 23:23:47.000	1686123170
2026-02-04 04:59:06.000	1436334215
2026-02-07 08:59:03.000	1472177450
2026-02-06 06:21:23.000	1283085689
2026-02-07 08:22:30.000	1943701617
2026-02-04 15:32:40.000	1291340029
2026-02-04 15:33:49.000	1818646345
2026-02-04 15:34:00.000	2070497852
2026-02-07 08:09:47.000	1458483471
2026-02-07 23:02:03.000	1449323429
2026-02-07 20:40:01.000	1659088129
2026-02-07 03:37:09.000	1516122235
2026-02-07 05:10:30.000	1708483659
2026-02-04 21:52:15.000	1769507317
2026-02-04 01:00:48.000	1821466756
2026-02-08 09:43:38.000	941554483
2026-02-08 09:38:29.000	1720209747
2026-02-06 07:39:59.000	1476103113
2026-02-07 02:32:36.000	2028397347
2026-02-07 02:30:15.000	1777678231
2026-02-07 00:02:42.000	2060458994
2026-02-04 08:09:04.000	1921469025
2026-02-06 21:18:39.000	1720765608
2026-02-05 09:52:13.000	1871645048
2026-02-03 04:23:03.000	1727270312
2026-02-07 18:07:58.000	1703560077
2026-02-07 18:05:30.000	2035353948
2026-02-08 04:05:50.000	1639010503
2026-02-03 20:16:23.000	1960340714
2026-02-04 10:02:02.000	1639803652
2026-02-02 02:13:59.000	1636551228
2026-02-08 23:42:33.000	2068745128
2026-02-08 23:50:27.000	1462512087
2026-02-06 03:59:07.000	1387618746

    `;

    if (fillDemoBtn) {
        fillDemoBtn.addEventListener('click', () => {
            inputArea.value = demoData;
            setMsg('å·²å¡«å……ç¤ºä¾‹æ•°æ®ï¼Œå¯ç›´æ¥ç‚¹å‡»â€œç”Ÿæˆå›¾è¡¨â€ã€‚', 'ok');
        });
    }

    generateBtn.addEventListener('click', () => {
        const text = inputArea.value.trim();
        if (!text) {
            setMsg('è¯·å…ˆç²˜è´´å†…å®¹æˆ–ä½¿ç”¨â€œå¡«å……ç¤ºä¾‹æ•°æ®â€ã€‚', 'error');
            return;
        }
        try {
            const data = parseTextToData(text);

            const startHHMM = startTimeInput.value || '00:00';
            const endHHMM = endTimeInput.value || '23:59';
            let stepMinutes = parseInt(granularityInput.value, 10) || 1;

            if (stepMinutes < 1 || stepMinutes > 60) {
                setMsg('ç²’åº¦å¿…é¡»åœ¨ 1~60 åˆ†é’Ÿä¹‹é—´ã€‚', 'error');
                return;
            }

            const startMinutes = hhmmToMinutes(startHHMM);
            const endMinutes = hhmmToMinutes(endHHMM);
            if (endMinutes < startMinutes) {
                setMsg('ç»“æŸæ—¶é—´ä¸èƒ½æ—©äºèµ·å§‹æ—¶é—´ã€‚', 'error');
                return;
            }

            const dateFilter = dateFilterInput.value || null;
            const compareDate = compareDateInput.value || null;
            const chartType = chartTypeSelect.value || 'line';

            if (compareDate && dateFilter && compareDate === dateFilter) {
                setMsg('â€œæ—¥æœŸâ€å’Œâ€œå¯¹æ¯”æ—¥æœŸâ€ä¸èƒ½ç›¸åŒã€‚', 'error');
                return;
            }

            const options = {
                startMinutes,
                endMinutes,
                stepMinutes,
                dateFilter,
                compareDate,
                chartType
            };

            renderChartFromData(data, options);

            let dateText;
            if (dateFilter && compareDate) {
                dateText = `æ—¥æœŸ=${dateFilter} ä¸ å¯¹æ¯”æ—¥æœŸ=${compareDate}ï¼Œ`;
            } else if (dateFilter) {
                dateText = `æ—¥æœŸ=${dateFilter}ï¼Œ`;
            } else if (compareDate) {
                dateText = `å¯¹æ¯”æ—¥æœŸ=${compareDate}ï¼ˆä¸»çº¿ä¸ºæ‰€æœ‰æ—¥æœŸæ±‡æ€»ï¼‰ï¼Œ`;
            } else {
                dateText = 'æ‰€æœ‰æ—¥æœŸæ±‡æ€»ï¼Œ';
            }

            setMsg(
                `è§£ææˆåŠŸï¼Œè®°å½•æ•°ï¼š${data.length}ï¼Œ${dateText}æ—¶é—´æ®µ ${startHHMM} ~ ${endHHMM}ï¼Œç²’åº¦ ${stepMinutes} åˆ†é’Ÿã€‚`,
                'ok'
            );
        } catch (e) {
            console.error(e);
            setMsg('è§£æå¤±è´¥ï¼š' + e.message, 'error');
        }
    });

    if (downloadTableBtn) {
        downloadTableBtn.addEventListener('click', downloadTableAsCSV);
    }

    function setMsg(text, type) {
        msg.textContent = text;
        msg.className = type === 'ok' ? 'ok' : (type === 'error' ? 'error' : '');
    }

    function hhmmToMinutes(hhmm) {
        const [h, m] = hhmm.split(':').map(x => parseInt(x, 10) || 0);
        return h * 60 + m;
    }

    function indexToHHMM(idx) {
        const h = Math.floor(idx / 60);
        const m = idx % 60;
        return String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
    }

    function parseTextToData(text) {
        const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
        if (lines.length === 0) {
            throw new Error('å†…å®¹ä¸ºç©º');
        }

        let startIndex = 0;
        let hasHeader = false;
        let headerCols = [];

        const firstLine = lines[0].trim();
        if (firstLine.toLowerCase().includes('time') && firstLine.toLowerCase().includes('role')) {
            hasHeader = true;
            startIndex = 1;
            headerCols = splitLine(firstLine);
        }

        const result = [];

        for (let i = startIndex; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;

            const cols = splitLine(line);
            if (cols.length < 2) continue;

            let time, roleid;

            if (hasHeader) {
                const colMap = {};
                headerCols.forEach((h, idx) => {
                    colMap[h.trim().toLowerCase()] = idx;
                });
                const tIdx = colMap['time'];
                const rIdx = colMap['roleid'];
                if (tIdx == null || rIdx == null) {
                    throw new Error('æ— æ³•æ ¹æ®è¡¨å¤´è¯†åˆ« time / roleid åˆ—');
                }
                time = cols[tIdx];
                roleid = cols[rIdx];
            } else {
                time = cols[0];
                roleid = cols[1];
            }

            time = String(time).trim();
            roleid = String(roleid).trim();
            if (!time) continue;

            result.push({ time, roleid });
        }

        if (result.length === 0) {
            throw new Error('æœªè§£æåˆ°ä»»ä½•æ•°æ®ï¼Œè¯·æ£€æŸ¥æ ¼å¼ã€‚');
        }

        return result;
    }

    function splitLine(line) {
        if (line.includes(',')) {
            return line.split(',').map(s => s.trim())};
        if (line.includes('\t')) {
            return line.split('\t').map(s => s.trim());
        }
        return line.split(/\s+/).map(s => s.trim());
    }

    function extractDate(timeStr) {
        if (!timeStr) return null;
        timeStr = String(timeStr).trim();
        if (timeStr.includes(' ')) {
            const parts = timeStr.split(' ');
            const maybeDate = parts[0];
            if (/^\d{4}-\d{2}-\d{2}$/.test(maybeDate)) {
                return maybeDate;
            }
        }
        return null;
    }

    function extractHHMM(timeStr) {
        if (!timeStr) return null;
        timeStr = String(timeStr).trim();

        let timePart = timeStr;
        if (timeStr.includes(' ')) {
            const parts = timeStr.split(' ');
            timePart = parts[1] || parts[0];
        }

        const tParts = timePart.split(':');
        if (tParts.length < 2) return null;

        let h = tParts[0];
        let m = tParts[1];

        if (m.includes('.')) {
            m = m.split('.')[0];
        }

        h = h.padStart(2, '0');
        m = m.padStart(2, '0');

        return `${h}:${m}`;
    }

    function renderChartFromData(
        data,
        { startMinutes, endMinutes, stepMinutes, dateFilter, compareDate, chartType }
    ) {
        const countsAll = {};
        const countsByDate = {};
        const roleCounts = {};
        let lastIdxForSummary = null;

        data.forEach(row => {
            const dateStr = extractDate(row.time);
            const hhmm = extractHHMM(row.time);
            if (!hhmm) return;

            const idx = hhmmToMinutes(hhmm);

            // å…¨éƒ¨æ—¥æœŸæ±‡æ€»ï¼ˆç”»â€œæ‰€æœ‰æ—¥æœŸâ€çš„æ›²çº¿ç”¨ï¼‰
            countsAll[idx] = (countsAll[idx] || 0) + 1;

            // æŒ‰æ¯ä¸ªæ—¥æœŸç»Ÿè®¡
            if (dateStr) {
                if (!countsByDate[dateStr]) countsByDate[dateStr] = {};
                countsByDate[dateStr][idx] = (countsByDate[dateStr][idx] || 0) + 1;
            }

            // ä¸»æ—¥æœŸ + æ—¶é—´æ®µå†…çš„è§’è‰²æ¬¡æ•°ï¼Œç”¨äº summary + é‡å¤è·å¥–
            const inTime = idx >= startMinutes && idx <= endMinutes;
            let inDate = true;
            if (dateFilter) {
                inDate = !!(dateStr && dateStr === dateFilter);
            } // compareDate ä¸å‚ä¸é‡å¤è·å¥–ç»Ÿè®¡

            if (inTime && inDate) {
                const rid = row.roleid;
                if (rid) {
                    roleCounts[rid] = (roleCounts[rid] || 0) + 1;
                }
                if (lastIdxForSummary === null || idx > lastIdxForSummary) {
                    lastIdxForSummary = idx;
                }
            }
        });

        // ä¸»æ›²çº¿ / å¯¹æ¯”æ›²çº¿çš„è®¡æ•°è¡¨
        let baseLabel;
        let baseCounts;
        let compareLabel = null;
        let compareCounts = null;

        if (dateFilter) {
            baseLabel = dateFilter;
            baseCounts = countsByDate[dateFilter] || {};
        } else {
            baseLabel = 'æ‰€æœ‰æ—¥æœŸæ±‡æ€»';
            baseCounts = countsAll;
        }

        if (compareDate && compareDate !== dateFilter) {
            compareLabel = compareDate;
            compareCounts = countsByDate[compareDate] || {};
        }

        const labels = [];
        const baseValues = [];
        const compareValues = [];

        for (let t = startMinutes; t <= endMinutes; t += stepMinutes) {
            const bandStart = t;
            const bandEnd = Math.min(t + stepMinutes, endMinutes + 1);

            let baseSum = 0;
            let compareSum = 0;

            for (let i = bandStart; i < bandEnd; i++) {
                if (baseCounts[i]) baseSum += baseCounts[i];
                if (compareCounts && compareCounts[i]) compareSum += compareCounts[i];
            }

            let label;
            if (stepMinutes === 1) {
                label = indexToHHMM(bandStart);
            } else {
                label = `${indexToHHMM(bandStart)} - ${indexToHHMM(bandEnd - 1)}`;
            }

            labels.push(label);
            baseValues.push(baseSum);
            if (compareCounts) compareValues.push(compareSum);
        }

        const baseColor = 'rgba(79, 70, 229, 1)';
        const baseBgBar = 'rgba(79, 70, 229, 0.95)';
        const compareColor = 'rgba(16, 185, 129, 1)';
        const compareBgBar = 'rgba(16, 185, 129, 0.95)';

        const datasets = [];

        datasets.push({
            label: `${baseLabel}ï¼šæ¯${stepMinutes}åˆ†é’Ÿè·å¥–æ¬¡æ•°`,
            data: baseValues,
            backgroundColor: chartType === 'bar'
                ? baseBgBar
                : 'rgba(129, 140, 248, 0.15)',
            borderColor: baseColor,
            borderWidth: chartType === 'bar' ? 1 : 1.5,
            tension: 0.25,
            pointRadius: chartType === 'line' ? 1.5 : 0,
            fill: chartType === 'line'
        });

        if (compareCounts) {
            datasets.push({
                label: `${compareLabel}ï¼šæ¯${stepMinutes}åˆ†é’Ÿè·å¥–æ¬¡æ•°`,
                data: compareValues,
                backgroundColor: chartType === 'bar'
                    ? compareBgBar
                    : 'rgba(34, 197, 94, 0.15)',
                borderColor: compareColor,
                borderWidth: chartType === 'bar' ? 1 : 1.5,
                tension: 0.25,
                pointRadius: chartType === 'line' ? 1.5 : 0,
                fill: false
            });
        }

        const canvas = document.getElementById('rewardChart');
        const ctx = canvas.getContext('2d');
        if (chartInstance) chartInstance.destroy();

        const bucketCount = labels.length;
        let perBucket = 8;
        if (stepMinutes >= 30) {
            perBucket = 16;
        }
        const minHeight = 300;
        const computedHeight = Math.max(minHeight, bucketCount * perBucket);
        canvas.style.height = computedHeight + 'px';

        chartInstance = new Chart(ctx, {
            type: chartType,
            data: {
                labels,
                datasets
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'nearest',
                    axis: 'y',
                    intersect: true
                },
                scales: {
                    y: {
                        title: {
                            display: true,
                            text: stepMinutes === 1
                                ? 'æ—¶é—´ï¼ˆåˆ†é’Ÿï¼ŒHH:MMï¼‰'
                                : `æ—¶é—´åŒºé—´ï¼ˆæ¯ ${stepMinutes} åˆ†é’Ÿï¼‰`
                        },
                        ticks: {
                            maxTicksLimit: 40
                        },
                        grid: {
                            display: chartType === 'bar' ? false : true
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'è·å¥–æ¬¡æ•°'
                        },
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(148, 163, 184, 0.3)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        labels: {
                            boxWidth: 12
                        }
                    },
                    tooltip: {
                        callbacks: {
                            title(items) {
                                return `æ—¶é—´ï¼š${items[0].label}`;
                            },
                            label(item) {
                                return `${item.dataset.label}ï¼š${item.formattedValue}`;
                            }
                        }
                    }
                }
            }
        });

        // ç´¯ç§¯æŠ•æ”¾ + æ—¶é—´è¿›åº¦
        renderSummary(roleCounts, dateFilter, startMinutes, endMinutes, lastIdxForSummary);
        // æ—¶é—´æ®µè¡¨æ ¼
        renderTable(labels, baseValues, compareValues, baseLabel, compareLabel, stepMinutes);
        // é‡å¤è·å¥–ç©å®¶
        renderRoleDuplicates(roleCounts);
    }

    function renderSummary(roleCounts, dateFilter, startMinutes, endMinutes, lastIdxForSummary) {
        const container = document.getElementById('summaryContainer');
        if (!container) return;

        const total = Object.values(roleCounts).reduce((sum, v) => sum + v, 0);
        const dateText = dateFilter ? `æ—¥æœŸ ${dateFilter}` : 'æ‰€æœ‰æ—¥æœŸ';

        const startHHMM = indexToHHMM(startMinutes);
        const endHHMM = indexToHHMM(endMinutes);

        let progressText = 'æ—¶é—´è¿›åº¦ï¼šæ— æ•°æ®';
        if (lastIdxForSummary !== null) {
            const minutesFromMidnight = lastIdxForSummary;
            const percent = (minutesFromMidnight / 1440) * 100;
            const percentText = percent.toFixed(2) + '%';
            const lastTimeHHMM = indexToHHMM(lastIdxForSummary);
            progressText = `æ—¶é—´è¿›åº¦ï¼šæœ€åè®°å½•æ—¶é—´ ${lastTimeHHMM}ï¼Œå å…¨å¤© ${percentText}`;
        }

        container.textContent =
            `${dateText} åœ¨ ${startHHMM} ~ ${endHHMM} æ—¶é—´æ®µå†…ï¼Œç´¯ç§¯å·²æŠ•æ”¾å¥–åŠ±æ•°é‡ï¼š${total}ï¼›` +
            progressText;
    }

    function renderTable(labels, baseValues, compareValues, baseLabel, compareLabel, stepMinutes) {
        const container = document.getElementById('tableContainer');
        if (!container) return;

        // ä¿å­˜ç”¨äºå¯¼å‡º
        lastTableLabels = labels.slice();
        lastTableBaseValues = baseValues.slice();
        lastTableCompareValues = compareValues ? compareValues.slice() : [];
        lastTableBaseLabel = baseLabel || 'ä¸»æ•°æ®';
        lastTableCompareLabel = compareLabel || '';
        lastTableStepMinutes = stepMinutes;

        if (!labels || labels.length === 0) {
            container.innerHTML = '';
            return;
        }

        const hasCompare = !!(compareLabel && compareValues && compareValues.length === labels.length);

        const rowValues = labels.map((_, i) => {
            const v1 = baseValues[i] || 0;
            const v2 = hasCompare ? (compareValues[i] || 0) : 0;
            return Math.max(v1, v2);
        });

        let minVal = Math.min(...rowValues);
        let maxVal = Math.max(...rowValues);
        if (minVal === maxVal) {
            minVal = maxVal - 1;
        }

        function normalize(v) {
            return (v - minVal) / (maxVal - minVal);
        }

        function valueToColor(v) {
            const t = normalize(v);
            function lerp(a, b, t) { return a + (b - a) * t; }

            let r, g, b;
            if (t <= 0.5) {
                const t2 = t / 0.5;
                r = lerp(0xe5, 0xff, t2);
                g = lerp(0xf9, 0xf7, t2);
                b = lerp(0xe7, 0xc2, t2);
            } else {
                const t2 = (t - 0.5) / 0.5;
                r = lerp(0xff, 0xfd, t2);
                g = lerp(0xf7, 0xe2, t2);
                b = lerp(0xc2, 0xe1, t2);
            }
            r = Math.round(r);
            g = Math.round(g);
            b = Math.round(b);
            return `rgb(${r}, ${g}, ${b})`;
        }

        let html = '<table><thead><tr>';
        html += '<th>æ—¶é—´' + (stepMinutes > 1 ? 'åŒºé—´' : '') + '</th>';
        html += `<th>${baseLabel || 'ä¸»æ•°æ®'}</th>`;
        if (hasCompare) {
            html += `<th>${compareLabel}</th>`;
        }
        html += '</tr></thead><tbody>';

        for (let i = 0; i < labels.length; i++) {
            const tLabel = labels[i];
            const baseVal = baseValues[i] || 0;
            const rowVal = rowValues[i];
            const bgColor = valueToColor(rowVal);

            html += `<tr style="background:${bgColor};">`;
            html += `<td>${tLabel}</td>`;
            html += `<td>${baseVal}</td>`;
            if (hasCompare) {
                const cmpVal = compareValues[i] || 0;
                html += `<td>${cmpVal}</td>`;
            }
            html += '</tr>';
        }

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function renderRoleDuplicates(roleCounts) {
        const container = document.getElementById('dupContainer');
        if (!container) return;

        const entries = Object.entries(roleCounts)
            .filter(([, count]) => count > 1)
            .sort((a, b) => b[1] - a[1]);

        if (entries.length === 0) {
            container.innerHTML = '<div class="dup-empty">å½“å‰ä¸»æ—¥æœŸ/æ—¶é—´æ®µå†…ï¼Œæ²¡æœ‰ç©å®¶è·å¾—å¤šä¸ªå¥–åŠ±ã€‚</div>';
            return;
        }

        let html = '<h3>å¤šæ¬¡è·å¾—å¥–åŠ±çš„ç©å®¶</h3>';
        html += '<table><thead><tr><th>roleid</th><th>è·å¾—æ¬¡æ•°</th></tr></thead><tbody>';

        for (const [roleid, count] of entries) {
            html += `<tr><td>${roleid}</td><td>${count}</td></tr>`;
        }

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    // å¯¼å‡ºæ—¶é—´æ®µè¡¨ä¸º CSV
    function downloadTableAsCSV() {
        if (!lastTableLabels || lastTableLabels.length === 0) {
            alert('å½“å‰æ²¡æœ‰å¯å¯¼å‡ºçš„è¡¨æ ¼æ•°æ®ï¼Œè¯·å…ˆç”Ÿæˆå›¾è¡¨ã€‚');
            return;
        }

        const hasCompare = !!(lastTableCompareLabel && lastTableCompareValues && lastTableCompareValues.length === lastTableLabels.length);

        const header = [
            'time' + (lastTableStepMinutes > 1 ? '_range' : ''),
            lastTableBaseLabel
        ];
        if (hasCompare) {
            header.push(lastTableCompareLabel);
        }

        const rows = [];
        rows.push(header);

        for (let i = 0; i < lastTableLabels.length; i++) {
            const row = [];
            row.push(lastTableLabels[i]);
            row.push(lastTableBaseValues[i] || 0);
            if (hasCompare) {
                row.push(lastTableCompareValues[i] || 0);
            }
            rows.push(row);
        }

        const lines = rows.map(cols =>
            cols
                .map(v => {
                    const s = String(v);
                    if (s.includes(',') || s.includes('"')) {
                        return '"' + s.replace(/"/g, '""') + '"';
                    }
                    return s;
                })
                .join(',')
        );
        const csvContent = lines.join('\r\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        const now = new Date();
        const ts = now.toISOString().slice(0,19).replace(/[:T]/g, '');
        a.href = url;
        a.download = `time_bucket_rewards_${ts}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
</script>
</body>
</html>



