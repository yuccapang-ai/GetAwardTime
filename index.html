<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ä¸€å¤©ä¸­æ¯åˆ†é’Ÿè·å¥–äººæ•°åˆ†å¸ƒï¼ˆå¯¹æ¯”ä¸¤å¤©ï¼‰</title>
    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            background: #f5f7fb;
            color: #333;
        }
        .page-wrapper {
            min-height: 100vh;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 40px 16px;
        }
        .card {
            width: 100%;
            max-width: 1100px;
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
            padding: 24px 28px 28px;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }
        .card-header-left h1 {
            margin: 0;
            font-size: 22px;
            font-weight: 600;
            color: #111827;
        }
        .card-header-left p {
            margin: 4px 0 0;
            font-size: 13px;
            color: #6b7280;
        }
        .card-header-right {
            text-align: right;
            font-size: 12px;
            color: #9ca3af;
        }
        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .section-title span.tag {
            font-size: 11px;
            padding: 1px 6px;
            border-radius: 999px;
            background: #eef2ff;
            color: #4f46e5;
        }
        .textarea-wrapper {
            margin-top: 6px;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            padding: 8px;
            transition: border-color 0.2s, box-shadow 0.2s, background 0.2s;
        }
        .textarea-wrapper:focus-within {
            border-color: #4f46e5;
            box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.25);
            background: #fff;
        }
        textarea {
            width: 100%;
            height: 160px;
            resize: vertical;
            border: none;
            outline: none;
            font-family: "JetBrains Mono", Consolas, "SFMono-Regular", Menlo, monospace;
            font-size: 12px;
            line-height: 1.4;
            background: transparent;
            color: #111827;
        }
        .example-box {
            font-size: 12px;
            color: #6b7280;
            background: #f3f4f6;
            border-radius: 8px;
            padding: 8px 10px;
            margin-top: 6px;
            white-space: pre-wrap;
            font-family: "JetBrains Mono", Consolas, monospace;
        }
        .control-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            margin-top: 12px;
            gap: 8px;
        }
        .btn-primary {
            border: none;
            outline: none;
            border-radius: 999px;
            padding: 8px 18px;
            font-size: 13px;
            font-weight: 500;
            background: linear-gradient(135deg, #4f46e5, #6366f1);
            color: #fff;
            cursor: pointer;
            box-shadow: 0 6px 16px rgba(79, 70, 229, 0.35);
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: transform 0.12s ease, box-shadow 0.12s ease, filter 0.12s;
        }
        .btn-primary:hover {
            filter: brightness(1.05);
            box-shadow: 0 8px 18px rgba(79, 70, 229, 0.45);
        }
        .btn-primary:active {
            transform: translateY(1px);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4);
        }
        .btn-primary span.icon {
            font-size: 15px;
        }
        #msg {
            font-size: 12px;
        }
        #msg.error { color: #b91c1c; }
        #msg.ok { color: #16a34a; }
        .hint {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 4px;
        }
        .filters {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px 16px;
            font-size: 12px;
            align-items: center;
        }
        .filter-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .filter-item label {
            color: #4b5563;
        }
        .filter-item input[type="time"],
        .filter-item input[type="number"],
        .filter-item input[type="date"],
        .filter-item select {
            font-size: 12px;
            padding: 4px 6px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
        }
        #chartContainer {
            width: 100%;
            max-height: 600px;
            margin-top: 18px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            padding: 10px;
            background: radial-gradient(circle at top left, #eef2ff 0, #ffffff 40%);
            overflow-y: auto;
        }
        /* ç´¯ç§¯æŠ•æ”¾ + æ—¶é—´è¿›åº¦ */
        #summaryContainer {
            margin-top: 16px;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            background: #ecfdf5;
            font-size: 12px;
            color: #166534;
        }
        /* æ—¶é—´æ®µè¡¨æ ¼ */
        #tableContainer {
            margin-top: 16px;
            max-height: 300px;
            overflow: auto;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            background: #ffffff;
            font-size: 12px;
        }
        #tableContainer table {
            width: 100%;
            border-collapse: collapse;
        }
        #tableContainer thead {
            background: #f3f4f6;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        #tableContainer th,
        #tableContainer td {
            padding: 6px 8px;
            border-bottom: 1px solid #e5e7eb;
            text-align: right;
        }
        #tableContainer th:first-child,
        #tableContainer td:first-child {
            text-align: left;
        }
        /* é‡å¤è·å¥–è§’è‰²åˆ—è¡¨ */
        #dupContainer {
            margin-top: 16px;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            background: #f9fafb;
            font-size: 12px;
        }
        #dupContainer h3 {
            margin: 0 0 6px;
            font-size: 13px;
            font-weight: 600;
            color: #374151;
        }
        #dupContainer table {
            width: 100%;
            border-collapse: collapse;
        }
        #dupContainer th,
        #dupContainer td {
            padding: 4px 6px;
            border-bottom: 1px solid #e5e7eb;
            text-align: right;
        }
        #dupContainer th:first-child,
        #dupContainer td:first-child {
            text-align: left;
        }
        #dupContainer .dup-empty {
            font-size: 12px;
            color: #6b7280;
        }
        @media (max-width: 768px) {
            .card {
                padding: 16px 14px 18px;
            }
            .card-header {
                flex-direction: column;
                gap: 6px;
            }
            .control-row {
                flex-direction: column;
                align-items: flex-start;
            }
            #chartContainer {
                max-height: 360px;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
<div class="page-wrapper">
    <div class="card">
        <div class="card-header">
            <div class="card-header-left">
                <h1>ä¸€å¤©ä¸­æ¯åˆ†é’Ÿè·å¥–äººæ•°åˆ†å¸ƒ</h1>
                <p>ç²˜è´´ time,roleidï¼ŒæŒ‰æ—¥æœŸ / æ—¶é—´æ®µ / ç²’åº¦ç»Ÿè®¡ï¼Œæ”¯æŒæŸ±çŠ¶å›¾ & æŠ˜çº¿å›¾ï¼Œä»¥åŠä¸¤å¤©å¯¹æ¯”ã€‚</p>
            </div>
            <div class="card-header-right">
                <div>æ—¶é—´ç»´åº¦ï¼šä¸€å¤©ä¸­çš„åˆ†é’Ÿï¼ˆå¯èšåˆï¼‰</div>
                <div>å›¾å½¢ï¼šçºµè½´ä¸ºæ—¶é—´ï¼ˆæˆ–æ—¶é—´æ®µï¼‰ï¼Œæ¨ªè½´ä¸ºè·å¥–æ¬¡æ•°</div>
            </div>
        </div>

        <div class="section-title">
            æ•°æ®è¾“å…¥
            <span class="tag">ç²˜è´´æ¨¡å¼</span>
        </div>
        <div class="example-box">
æ”¯æŒçš„ time æ ¼å¼ç¤ºä¾‹ï¼š
time,roleid
16:20,2045401754
13:33,1522960124
2026-02-02 02:37:14.000,1451304816
2026-02-03 18:01:03.500,1234567890
        </div>

        <div class="textarea-wrapper">
            <textarea id="inputArea" placeholder="åœ¨è¿™é‡Œç²˜è´´ time,roleid çš„è¡¨æ ¼å†…å®¹ï¼ˆæ”¯æŒ HH:MM æˆ– YYYY-MM-DD HH:MM:SS.sssï¼Œé€—å·æˆ– Tab/ç©ºæ ¼åˆ†éš”ï¼‰"></textarea>
        </div>
        <div class="hint">å¯ä»¥åŒ…å«è¡¨å¤´ï¼ˆä¾‹å¦‚ time,roleidï¼‰ã€‚</div>

        <div class="filters">
            <div class="filter-item">
                <label for="dateFilter">æ—¥æœŸï¼š</label>
                <input id="dateFilter" type="date">
                <span style="font-size:11px;color:#9ca3af;">ç•™ç©º=æ‰€æœ‰æ—¥æœŸæ±‡æ€»</span>
            </div>
            <div class="filter-item">
                <label for="compareDate">å¯¹æ¯”æ—¥æœŸï¼š</label>
                <input id="compareDate" type="date">
                <span style="font-size:11px;color:#9ca3af;">å¯é€‰ï¼Œç”¨äºç”»ç¬¬äºŒæ¡çº¿</span>
            </div>
            <div class="filter-item">
                <label for="startTime">èµ·å§‹æ—¶é—´ï¼š</label>
                <input id="startTime" type="time" value="00:00">
            </div>
            <div class="filter-item">
                <label for="endTime">ç»“æŸæ—¶é—´ï¼š</label>
                <input id="endTime" type="time" value="23:59">
            </div>
            <div class="filter-item">
                <label for="granularity">ç²’åº¦ï¼š</label>
                <input id="granularity" type="number" min="1" max="60" value="1" style="width:70px;">
                <span>åˆ†é’Ÿï¼ˆ1~60ï¼‰</span>
            </div>
            <div class="filter-item">
                <label for="chartType">å›¾è¡¨ç±»å‹ï¼š</label>
                <select id="chartType">
                    <option value="bar">æŸ±çŠ¶å›¾</option>
                    <option value="line" selected>æŠ˜çº¿å›¾</option>
                </select>
            </div>
        </div>

        <div class="control-row">
            <div>
                <button id="fillDemoBtn" class="btn-primary" style="margin-right:8px;">
                    <span class="icon">ğŸ“‹</span>
                    <span>å¡«å……ç¤ºä¾‹æ•°æ®</span>
                </button>
                <button id="generateBtn" class="btn-primary">
                    <span class="icon">ğŸ“Š</span>
                    <span>ç”Ÿæˆå›¾è¡¨</span>
                </button>
            </div>
            <div id="msg"></div>
        </div>

        <div id="chartContainer">
            <canvas id="rewardChart"></canvas>
        </div>

        <!-- ç´¯ç§¯æŠ•æ”¾ + æ—¶é—´è¿›åº¦ -->
        <div id="summaryContainer"></div>

        <!-- ä¸‹è½½æŒ‰é’® + æ—¶é—´æ®µè¡¨ -->
        <div style="margin-top: 12px; display:flex; justify-content: space-between; align-items: center; gap:8px;">
            <div style="font-size:12px; color:#6b7280;">æ—¶é—´æ®µ-è·å¥–æ¬¡æ•°è¡¨</div>
            <button id="downloadTableBtn" class="btn-primary" style="padding:4px 10px; font-size:11px; box-shadow:none;">
                <span class="icon">â¬‡</span>
                <span>ä¸‹è½½è¡¨æ ¼ï¼ˆCSVï¼‰</span>
            </button>
        </div>
        <div id="tableContainer"></div>

        <!-- é‡å¤è·å¥–è§’è‰²åˆ—è¡¨ -->
        <div id="dupContainer"></div>
    </div>
</div>

<script>
    const inputArea = document.getElementById('inputArea');
    const generateBtn = document.getElementById('generateBtn');
    const fillDemoBtn = document.getElementById('fillDemoBtn');
    const downloadTableBtn = document.getElementById('downloadTableBtn');
    const msg = document.getElementById('msg');
    const startTimeInput = document.getElementById('startTime');
    const endTimeInput = document.getElementById('endTime');
    const granularityInput = document.getElementById('granularity');
    const dateFilterInput = document.getElementById('dateFilter');
    const compareDateInput = document.getElementById('compareDate');
    const chartTypeSelect = document.getElementById('chartType');

    let chartInstance = null;
    // ç”¨äºå¯¼å‡ºè¡¨æ ¼çš„æ•°æ®
    let lastTableLabels = [];
    let lastTableBaseValues = [];
    let lastTableCompareValues = [];
    let lastTableBaseLabel = '';
    let lastTableCompareLabel = '';
    let lastTableStepMinutes = 1;

    // ç¤ºä¾‹æ•°æ®
    const demoData = `time	roleid
2026-02-03 15:17:27.000	1731646159
2026-02-04 04:37:40.000	1844914610
2026-02-03 15:05:11.000	1947159311
2026-02-04 04:14:02.000	2066356629
2026-02-04 05:34:13.000	2067259478
2026-02-02 03:22:18.000	1919897307
2026-02-02 03:25:39.000	1484461954
2026-02-02 03:29:09.000	2056244153
2026-02-02 03:31:18.000	1466950722
2026-02-03 10:45:53.000	1737114945
2026-02-03 18:03:04.000	1774898987
2026-02-03 10:33:00.000	2037301604
2026-02-02 04:20:49.000	2069673586
2026-02-03 03:53:34.000	1957897023
2026-02-04 03:58:55.000	1676498107
2026-02-03 07:16:53.000	1768549811
2026-02-02 02:36:47.000	1747073145
2026-02-03 08:32:51.000	1774963282
2026-02-03 23:25:16.000	1647624453
2026-02-03 04:23:03.000	1727270312
2026-02-04 00:40:56.000	1699386364
2026-02-04 00:48:06.000	1718639642
2026-02-04 00:44:22.000	1642710920
2026-02-02 23:29:59.000	1627319199
2026-02-02 06:36:35.000	1788956398
2026-02-03 18:50:19.000	1906588215
2026-02-03 19:01:07.000	1769578502
2026-02-03 06:06:22.000	1328684060
2026-02-02 19:15:00.000	1911247698
2026-02-02 19:19:23.000	1541501534
2026-02-03 01:03:20.000	1938021624
2026-02-03 01:02:17.000	1760451548
2026-02-02 06:51:41.000	1713762799
2026-02-03 01:13:36.000	2070953722
2026-02-02 03:30:49.000	2063962931
2026-02-02 03:29:25.000	1875464338
2026-02-02 03:29:51.000	1760783534
2026-02-02 03:29:30.000	1522118469
2026-02-02 03:28:21.000	1482615432
2026-02-04 04:59:06.000	1436334215
2026-02-02 19:54:32.000	1899922846
2026-02-02 03:50:12.000	1937270369
2026-02-02 03:15:31.000	823877375
2026-02-02 03:15:06.000	1679758585
2026-02-02 23:07:37.000	755904204
2026-02-03 20:16:23.000	1960340714
2026-02-03 21:55:44.000	1942072860
2026-02-03 22:02:24.000	1901239486
2026-02-03 19:17:10.000	1881229191
2026-02-04 01:17:07.000	1985841727
2026-02-03 21:06:23.000	1670351636
2026-02-04 00:42:09.000	1732159189
2026-02-03 07:08:02.000	2064757339
2026-02-03 07:05:23.000	1682949639
2026-02-03 07:04:53.000	2071823166
2026-02-04 04:09:20.000	1585353465
2026-02-04 05:41:23.000	1651296390
2026-02-02 03:36:57.000	1673667710
2026-02-02 03:32:41.000	1928947583
2026-02-02 03:35:48.000	1467963182
2026-02-04 03:22:36.000	1340501926
2026-02-03 04:44:39.000	1675611461
2026-02-03 06:09:26.000	2046692386
2026-02-03 02:24:59.000	1808839592
2026-02-03 19:04:04.000	1676302743
2026-02-03 18:37:22.000	1374219859
2026-02-02 03:42:51.000	1448887042
2026-02-03 22:58:53.000	2066666692
2026-02-03 22:53:15.000	2070230419
2026-02-03 22:58:25.000	1732199109
2026-02-02 01:58:41.000	1395285932
2026-02-02 02:04:42.000	1654207327
2026-02-02 06:02:33.000	1441439186
2026-02-02 17:10:07.000	1645579294
2026-02-02 21:20:47.000	2017148959
2026-02-02 21:19:37.000	2063800322
2026-02-02 16:58:12.000	1659432035
2026-02-04 02:02:32.000	2071916475
2026-02-03 06:25:19.000	1682077786
2026-02-02 23:40:26.000	1688103345
2026-02-02 23:46:45.000	1865847739
2026-02-02 03:34:55.000	1321907309
2026-02-02 03:40:28.000	2062460012
2026-02-02 03:39:28.000	1924024565
2026-02-03 19:22:37.000	1658571179
2026-02-03 19:30:50.000	1443413660
2026-02-03 03:50:57.000	1368923365
2026-02-04 00:57:43.000	1521067340
2026-02-02 05:08:45.000	1771880068
2026-02-02 20:17:26.000	651134614
2026-02-03 06:55:06.000	2069713420
2026-02-02 02:09:40.000	2065032776
2026-02-02 02:11:03.000	1876457350
2026-02-02 02:09:31.000	1393816662
2026-02-04 02:37:47.000	1785644425
2026-02-03 01:46:16.000	1288198619
2026-02-04 03:55:01.000	1505342405
2026-02-03 06:42:02.000	1721995311
2026-02-03 04:57:01.000	1511354239
2026-02-04 01:43:46.000	1881425603
2026-02-04 02:23:22.000	1493913559
2026-02-03 20:48:00.000	1946663096
2026-02-02 21:47:48.000	1725687405
2026-02-02 22:31:36.000	2023023372
2026-02-02 22:22:50.000	1976167120
2026-02-02 05:28:01.000	1715295594
2026-02-02 17:27:27.000	1451304816
2026-02-03 07:54:40.000	2003962554
2026-02-02 21:12:46.000	1270782388
2026-02-02 02:13:59.000	1636551228
2026-02-02 02:58:04.000	1928446205
2026-02-02 02:58:40.000	1666085463
2026-02-02 03:04:55.000	767625706
2026-02-02 03:05:50.000	2030302332
2026-02-02 02:19:10.000	1968215016
2026-02-02 02:19:42.000	1643607534
2026-02-03 19:37:47.000	1726210900
2026-02-04 01:57:42.000	1773949163
2026-02-03 22:22:14.000	1888239878
2026-02-02 02:36:13.000	1494170771
2026-02-02 02:37:14.000	2070815675
2026-02-03 18:06:35.000	1919821869
2026-02-04 03:09:53.000	1891315242
2026-02-03 21:31:39.000	1920913493
2026-02-02 18:20:50.000	1697033841
2026-02-02 03:57:37.000	1463810346
2026-02-02 03:01:15.000	1697404236
2026-02-02 03:02:30.000	1662062106
2026-02-02 03:07:33.000	1856972367
2026-02-02 02:59:52.000	1769666405
2026-02-02 02:58:38.000	1807093398
2026-02-02 03:00:47.000	1849681272
2026-02-03 09:43:58.000	1732058358
2026-02-03 22:41:12.000	1894803420
2026-02-03 22:47:22.000	1715321814
2026-02-02 05:13:12.000	1870598124
2026-02-02 05:12:58.000	829172084
2026-02-03 23:40:39.000	1664973535
2026-02-02 02:52:43.000	1496147681
2026-02-02 02:18:36.000	1869052745
2026-02-02 02:25:17.000	1872523104
2026-02-02 02:22:26.000	1700833210
2026-02-04 04:40:03.000	1424068270
2026-02-02 08:32:07.000	1293684679
2026-02-03 05:22:01.000	1750548230
2026-02-02 02:04:41.000	1827753263
2026-02-02 02:41:22.000	2008010854
2026-02-02 13:33:14.000	1522960124
2026-02-04 01:00:48.000	1821466756
2026-02-02 05:27:42.000	1410104394
2026-02-02 02:41:10.000	1933679215
2026-02-02 02:40:39.000	1261949569
2026-02-02 18:48:13.000	1668009785
2026-02-02 18:56:53.000	1449066764
2026-02-02 03:55:21.000	2055523844
2026-02-02 03:53:53.000	1831778330
2026-02-02 03:46:42.000	1782124339
2026-02-02 03:46:59.000	1457713696
2026-02-02 03:46:30.000	2066698137
2026-02-02 03:52:39.000	1743426511
2026-02-02 21:05:03.000	1933285192
2026-02-02 04:13:31.000	1411527591
2026-02-04 02:52:59.000	2063472413
2026-02-02 18:36:25.000	2064442628
2026-02-02 03:12:18.000	1913697389
2026-02-02 03:15:34.000	2062148318
2026-02-02 03:13:37.000	2001926919
2026-02-02 03:14:11.000	1255402835
2026-02-02 16:20:15.000	2045401754
2026-02-03 04:00:39.000	1998297096
2026-02-02 03:27:56.000	1434088255
2026-02-02 03:21:34.000	1936087805
2026-02-03 17:40:23.000	1884913241
2026-02-04 06:15:55.000	2053643147
2026-02-04 06:14:48.000	1257041897
2026-02-04 05:03:53.000	1710054924
2026-02-03 22:12:59.000	1282651210
2026-02-03 22:08:23.000	2029339040
2026-02-03 22:15:49.000	1668794744
2026-02-02 17:22:00.000	2069543553
2026-02-02 23:02:18.000	1813627528
    `;

    if (fillDemoBtn) {
        fillDemoBtn.addEventListener('click', () => {
            inputArea.value = demoData;
            setMsg('å·²å¡«å……ç¤ºä¾‹æ•°æ®ï¼Œå¯ç›´æ¥ç‚¹å‡»â€œç”Ÿæˆå›¾è¡¨â€ã€‚', 'ok');
        });
    }

    generateBtn.addEventListener('click', () => {
        const text = inputArea.value.trim();
        if (!text) {
            setMsg('è¯·å…ˆç²˜è´´å†…å®¹æˆ–ä½¿ç”¨â€œå¡«å……ç¤ºä¾‹æ•°æ®â€ã€‚', 'error');
            return;
        }
        try {
            const data = parseTextToData(text);

            const startHHMM = startTimeInput.value || '00:00';
            const endHHMM = endTimeInput.value || '23:59';
            let stepMinutes = parseInt(granularityInput.value, 10) || 1;

            if (stepMinutes < 1 || stepMinutes > 60) {
                setMsg('ç²’åº¦å¿…é¡»åœ¨ 1~60 åˆ†é’Ÿä¹‹é—´ã€‚', 'error');
                return;
            }

            const startMinutes = hhmmToMinutes(startHHMM);
            const endMinutes = hhmmToMinutes(endHHMM);
            if (endMinutes < startMinutes) {
                setMsg('ç»“æŸæ—¶é—´ä¸èƒ½æ—©äºèµ·å§‹æ—¶é—´ã€‚', 'error');
                return;
            }

            const dateFilter = dateFilterInput.value || null;
            const compareDate = compareDateInput.value || null;
            const chartType = chartTypeSelect.value || 'line';

            if (compareDate && dateFilter && compareDate === dateFilter) {
                setMsg('â€œæ—¥æœŸâ€å’Œâ€œå¯¹æ¯”æ—¥æœŸâ€ä¸èƒ½ç›¸åŒã€‚', 'error');
                return;
            }

            const options = {
                startMinutes,
                endMinutes,
                stepMinutes,
                dateFilter,
                compareDate,
                chartType
            };

            renderChartFromData(data, options);

            let dateText;
            if (dateFilter && compareDate) {
                dateText = `æ—¥æœŸ=${dateFilter} ä¸ å¯¹æ¯”æ—¥æœŸ=${compareDate}ï¼Œ`;
            } else if (dateFilter) {
                dateText = `æ—¥æœŸ=${dateFilter}ï¼Œ`;
            } else if (compareDate) {
                dateText = `å¯¹æ¯”æ—¥æœŸ=${compareDate}ï¼ˆä¸»çº¿ä¸ºæ‰€æœ‰æ—¥æœŸæ±‡æ€»ï¼‰ï¼Œ`;
            } else {
                dateText = 'æ‰€æœ‰æ—¥æœŸæ±‡æ€»ï¼Œ';
            }

            setMsg(
                `è§£ææˆåŠŸï¼Œè®°å½•æ•°ï¼š${data.length}ï¼Œ${dateText}æ—¶é—´æ®µ ${startHHMM} ~ ${endHHMM}ï¼Œç²’åº¦ ${stepMinutes} åˆ†é’Ÿã€‚`,
                'ok'
            );
        } catch (e) {
            console.error(e);
            setMsg('è§£æå¤±è´¥ï¼š' + e.message, 'error');
        }
    });

    if (downloadTableBtn) {
        downloadTableBtn.addEventListener('click', downloadTableAsCSV);
    }

    function setMsg(text, type) {
        msg.textContent = text;
        msg.className = type === 'ok' ? 'ok' : (type === 'error' ? 'error' : '');
    }

    function hhmmToMinutes(hhmm) {
        const [h, m] = hhmm.split(':').map(x => parseInt(x, 10) || 0);
        return h * 60 + m;
    }

    function indexToHHMM(idx) {
        const h = Math.floor(idx / 60);
        const m = idx % 60;
        return String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
    }

    function parseTextToData(text) {
        const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
        if (lines.length === 0) {
            throw new Error('å†…å®¹ä¸ºç©º');
        }

        let startIndex = 0;
        let hasHeader = false;
        let headerCols = [];

        const firstLine = lines[0].trim();
        if (firstLine.toLowerCase().includes('time') && firstLine.toLowerCase().includes('role')) {
            hasHeader = true;
            startIndex = 1;
            headerCols = splitLine(firstLine);
        }

        const result = [];

        for (let i = startIndex; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;

            const cols = splitLine(line);
            if (cols.length < 2) continue;

            let time, roleid;

            if (hasHeader) {
                const colMap = {};
                headerCols.forEach((h, idx) => {
                    colMap[h.trim().toLowerCase()] = idx;
                });
                const tIdx = colMap['time'];
                const rIdx = colMap['roleid'];
                if (tIdx == null || rIdx == null) {
                    throw new Error('æ— æ³•æ ¹æ®è¡¨å¤´è¯†åˆ« time / roleid åˆ—');
                }
                time = cols[tIdx];
                roleid = cols[rIdx];
            } else {
                time = cols[0];
                roleid = cols[1];
            }

            time = String(time).trim();
            roleid = String(roleid).trim();
            if (!time) continue;

            result.push({ time, roleid });
        }

        if (result.length === 0) {
            throw new Error('æœªè§£æåˆ°ä»»ä½•æ•°æ®ï¼Œè¯·æ£€æŸ¥æ ¼å¼ã€‚');
        }

        return result;
    }

    function splitLine(line) {
        if (line.includes(',')) {
            return line.split(',').map(s => s.trim())};
        if (line.includes('\t')) {
            return line.split('\t').map(s => s.trim());
        }
        return line.split(/\s+/).map(s => s.trim());
    }

    function extractDate(timeStr) {
        if (!timeStr) return null;
        timeStr = String(timeStr).trim();
        if (timeStr.includes(' ')) {
            const parts = timeStr.split(' ');
            const maybeDate = parts[0];
            if (/^\d{4}-\d{2}-\d{2}$/.test(maybeDate)) {
                return maybeDate;
            }
        }
        return null;
    }

    function extractHHMM(timeStr) {
        if (!timeStr) return null;
        timeStr = String(timeStr).trim();

        let timePart = timeStr;
        if (timeStr.includes(' ')) {
            const parts = timeStr.split(' ');
            timePart = parts[1] || parts[0];
        }

        const tParts = timePart.split(':');
        if (tParts.length < 2) return null;

        let h = tParts[0];
        let m = tParts[1];

        if (m.includes('.')) {
            m = m.split('.')[0];
        }

        h = h.padStart(2, '0');
        m = m.padStart(2, '0');

        return `${h}:${m}`;
    }

    function renderChartFromData(
        data,
        { startMinutes, endMinutes, stepMinutes, dateFilter, compareDate, chartType }
    ) {
        const countsAll = {};
        const countsByDate = {};
        const roleCounts = {};
        let lastIdxForSummary = null;

        data.forEach(row => {
            const dateStr = extractDate(row.time);
            const hhmm = extractHHMM(row.time);
            if (!hhmm) return;

            const idx = hhmmToMinutes(hhmm);

            // å…¨éƒ¨æ—¥æœŸæ±‡æ€»ï¼ˆç”»â€œæ‰€æœ‰æ—¥æœŸâ€çš„æ›²çº¿ç”¨ï¼‰
            countsAll[idx] = (countsAll[idx] || 0) + 1;

            // æŒ‰æ¯ä¸ªæ—¥æœŸç»Ÿè®¡
            if (dateStr) {
                if (!countsByDate[dateStr]) countsByDate[dateStr] = {};
                countsByDate[dateStr][idx] = (countsByDate[dateStr][idx] || 0) + 1;
            }

            // ä¸»æ—¥æœŸ + æ—¶é—´æ®µå†…çš„è§’è‰²æ¬¡æ•°ï¼Œç”¨äº summary + é‡å¤è·å¥–
            const inTime = idx >= startMinutes && idx <= endMinutes;
            let inDate = true;
            if (dateFilter) {
                inDate = !!(dateStr && dateStr === dateFilter);
            } // compareDate ä¸å‚ä¸é‡å¤è·å¥–ç»Ÿè®¡

            if (inTime && inDate) {
                const rid = row.roleid;
                if (rid) {
                    roleCounts[rid] = (roleCounts[rid] || 0) + 1;
                }
                if (lastIdxForSummary === null || idx > lastIdxForSummary) {
                    lastIdxForSummary = idx;
                }
            }
        });

        // ä¸»æ›²çº¿ / å¯¹æ¯”æ›²çº¿çš„è®¡æ•°è¡¨
        let baseLabel;
        let baseCounts;
        let compareLabel = null;
        let compareCounts = null;

        if (dateFilter) {
            baseLabel = dateFilter;
            baseCounts = countsByDate[dateFilter] || {};
        } else {
            baseLabel = 'æ‰€æœ‰æ—¥æœŸæ±‡æ€»';
            baseCounts = countsAll;
        }

        if (compareDate && compareDate !== dateFilter) {
            compareLabel = compareDate;
            compareCounts = countsByDate[compareDate] || {};
        }

        const labels = [];
        const baseValues = [];
        const compareValues = [];

        for (let t = startMinutes; t <= endMinutes; t += stepMinutes) {
            const bandStart = t;
            const bandEnd = Math.min(t + stepMinutes, endMinutes + 1);

            let baseSum = 0;
            let compareSum = 0;

            for (let i = bandStart; i < bandEnd; i++) {
                if (baseCounts[i]) baseSum += baseCounts[i];
                if (compareCounts && compareCounts[i]) compareSum += compareCounts[i];
            }

            let label;
            if (stepMinutes === 1) {
                label = indexToHHMM(bandStart);
            } else {
                label = `${indexToHHMM(bandStart)} - ${indexToHHMM(bandEnd - 1)}`;
            }

            labels.push(label);
            baseValues.push(baseSum);
            if (compareCounts) compareValues.push(compareSum);
        }

        const baseColor = 'rgba(79, 70, 229, 1)';
        const baseBgBar = 'rgba(79, 70, 229, 0.95)';
        const compareColor = 'rgba(16, 185, 129, 1)';
        const compareBgBar = 'rgba(16, 185, 129, 0.95)';

        const datasets = [];

        datasets.push({
            label: `${baseLabel}ï¼šæ¯${stepMinutes}åˆ†é’Ÿè·å¥–æ¬¡æ•°`,
            data: baseValues,
            backgroundColor: chartType === 'bar'
                ? baseBgBar
                : 'rgba(129, 140, 248, 0.15)',
            borderColor: baseColor,
            borderWidth: chartType === 'bar' ? 1 : 1.5,
            tension: 0.25,
            pointRadius: chartType === 'line' ? 1.5 : 0,
            fill: chartType === 'line'
        });

        if (compareCounts) {
            datasets.push({
                label: `${compareLabel}ï¼šæ¯${stepMinutes}åˆ†é’Ÿè·å¥–æ¬¡æ•°`,
                data: compareValues,
                backgroundColor: chartType === 'bar'
                    ? compareBgBar
                    : 'rgba(34, 197, 94, 0.15)',
                borderColor: compareColor,
                borderWidth: chartType === 'bar' ? 1 : 1.5,
                tension: 0.25,
                pointRadius: chartType === 'line' ? 1.5 : 0,
                fill: false
            });
        }

        const canvas = document.getElementById('rewardChart');
        const ctx = canvas.getContext('2d');
        if (chartInstance) chartInstance.destroy();

        const bucketCount = labels.length;
        let perBucket = 8;
        if (stepMinutes >= 30) {
            perBucket = 16;
        }
        const minHeight = 300;
        const computedHeight = Math.max(minHeight, bucketCount * perBucket);
        canvas.style.height = computedHeight + 'px';

        chartInstance = new Chart(ctx, {
            type: chartType,
            data: {
                labels,
                datasets
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'nearest',
                    axis: 'y',
                    intersect: true
                },
                scales: {
                    y: {
                        title: {
                            display: true,
                            text: stepMinutes === 1
                                ? 'æ—¶é—´ï¼ˆåˆ†é’Ÿï¼ŒHH:MMï¼‰'
                                : `æ—¶é—´åŒºé—´ï¼ˆæ¯ ${stepMinutes} åˆ†é’Ÿï¼‰`
                        },
                        ticks: {
                            maxTicksLimit: 40
                        },
                        grid: {
                            display: chartType === 'bar' ? false : true
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'è·å¥–æ¬¡æ•°'
                        },
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(148, 163, 184, 0.3)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        labels: {
                            boxWidth: 12
                        }
                    },
                    tooltip: {
                        callbacks: {
                            title(items) {
                                return `æ—¶é—´ï¼š${items[0].label}`;
                            },
                            label(item) {
                                return `${item.dataset.label}ï¼š${item.formattedValue}`;
                            }
                        }
                    }
                }
            }
        });

        // ç´¯ç§¯æŠ•æ”¾ + æ—¶é—´è¿›åº¦
        renderSummary(roleCounts, dateFilter, startMinutes, endMinutes, lastIdxForSummary);
        // æ—¶é—´æ®µè¡¨æ ¼
        renderTable(labels, baseValues, compareValues, baseLabel, compareLabel, stepMinutes);
        // é‡å¤è·å¥–ç©å®¶
        renderRoleDuplicates(roleCounts);
    }

    function renderSummary(roleCounts, dateFilter, startMinutes, endMinutes, lastIdxForSummary) {
        const container = document.getElementById('summaryContainer');
        if (!container) return;

        const total = Object.values(roleCounts).reduce((sum, v) => sum + v, 0);
        const dateText = dateFilter ? `æ—¥æœŸ ${dateFilter}` : 'æ‰€æœ‰æ—¥æœŸ';

        const startHHMM = indexToHHMM(startMinutes);
        const endHHMM = indexToHHMM(endMinutes);

        let progressText = 'æ—¶é—´è¿›åº¦ï¼šæ— æ•°æ®';
        if (lastIdxForSummary !== null) {
            const minutesFromMidnight = lastIdxForSummary;
            const percent = (minutesFromMidnight / 1440) * 100;
            const percentText = percent.toFixed(2) + '%';
            const lastTimeHHMM = indexToHHMM(lastIdxForSummary);
            progressText = `æ—¶é—´è¿›åº¦ï¼šæœ€åè®°å½•æ—¶é—´ ${lastTimeHHMM}ï¼Œå å…¨å¤© ${percentText}`;
        }

        container.textContent =
            `${dateText} åœ¨ ${startHHMM} ~ ${endHHMM} æ—¶é—´æ®µå†…ï¼Œç´¯ç§¯å·²æŠ•æ”¾å¥–åŠ±æ•°é‡ï¼š${total}ï¼›` +
            progressText;
    }

    function renderTable(labels, baseValues, compareValues, baseLabel, compareLabel, stepMinutes) {
        const container = document.getElementById('tableContainer');
        if (!container) return;

        // ä¿å­˜ç”¨äºå¯¼å‡º
        lastTableLabels = labels.slice();
        lastTableBaseValues = baseValues.slice();
        lastTableCompareValues = compareValues ? compareValues.slice() : [];
        lastTableBaseLabel = baseLabel || 'ä¸»æ•°æ®';
        lastTableCompareLabel = compareLabel || '';
        lastTableStepMinutes = stepMinutes;

        if (!labels || labels.length === 0) {
            container.innerHTML = '';
            return;
        }

        const hasCompare = !!(compareLabel && compareValues && compareValues.length === labels.length);

        const rowValues = labels.map((_, i) => {
            const v1 = baseValues[i] || 0;
            const v2 = hasCompare ? (compareValues[i] || 0) : 0;
            return Math.max(v1, v2);
        });

        let minVal = Math.min(...rowValues);
        let maxVal = Math.max(...rowValues);
        if (minVal === maxVal) {
            minVal = maxVal - 1;
        }

        function normalize(v) {
            return (v - minVal) / (maxVal - minVal);
        }

        function valueToColor(v) {
            const t = normalize(v);
            function lerp(a, b, t) { return a + (b - a) * t; }

            let r, g, b;
            if (t <= 0.5) {
                const t2 = t / 0.5;
                r = lerp(0xe5, 0xff, t2);
                g = lerp(0xf9, 0xf7, t2);
                b = lerp(0xe7, 0xc2, t2);
            } else {
                const t2 = (t - 0.5) / 0.5;
                r = lerp(0xff, 0xfd, t2);
                g = lerp(0xf7, 0xe2, t2);
                b = lerp(0xc2, 0xe1, t2);
            }
            r = Math.round(r);
            g = Math.round(g);
            b = Math.round(b);
            return `rgb(${r}, ${g}, ${b})`;
        }

        let html = '<table><thead><tr>';
        html += '<th>æ—¶é—´' + (stepMinutes > 1 ? 'åŒºé—´' : '') + '</th>';
        html += `<th>${baseLabel || 'ä¸»æ•°æ®'}</th>`;
        if (hasCompare) {
            html += `<th>${compareLabel}</th>`;
        }
        html += '</tr></thead><tbody>';

        for (let i = 0; i < labels.length; i++) {
            const tLabel = labels[i];
            const baseVal = baseValues[i] || 0;
            const rowVal = rowValues[i];
            const bgColor = valueToColor(rowVal);

            html += `<tr style="background:${bgColor};">`;
            html += `<td>${tLabel}</td>`;
            html += `<td>${baseVal}</td>`;
            if (hasCompare) {
                const cmpVal = compareValues[i] || 0;
                html += `<td>${cmpVal}</td>`;
            }
            html += '</tr>';
        }

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    function renderRoleDuplicates(roleCounts) {
        const container = document.getElementById('dupContainer');
        if (!container) return;

        const entries = Object.entries(roleCounts)
            .filter(([, count]) => count > 1)
            .sort((a, b) => b[1] - a[1]);

        if (entries.length === 0) {
            container.innerHTML = '<div class="dup-empty">å½“å‰ä¸»æ—¥æœŸ/æ—¶é—´æ®µå†…ï¼Œæ²¡æœ‰ç©å®¶è·å¾—å¤šä¸ªå¥–åŠ±ã€‚</div>';
            return;
        }

        let html = '<h3>å¤šæ¬¡è·å¾—å¥–åŠ±çš„ç©å®¶</h3>';
        html += '<table><thead><tr><th>roleid</th><th>è·å¾—æ¬¡æ•°</th></tr></thead><tbody>';

        for (const [roleid, count] of entries) {
            html += `<tr><td>${roleid}</td><td>${count}</td></tr>`;
        }

        html += '</tbody></table>';
        container.innerHTML = html;
    }

    // å¯¼å‡ºæ—¶é—´æ®µè¡¨ä¸º CSV
    function downloadTableAsCSV() {
        if (!lastTableLabels || lastTableLabels.length === 0) {
            alert('å½“å‰æ²¡æœ‰å¯å¯¼å‡ºçš„è¡¨æ ¼æ•°æ®ï¼Œè¯·å…ˆç”Ÿæˆå›¾è¡¨ã€‚');
            return;
        }

        const hasCompare = !!(lastTableCompareLabel && lastTableCompareValues && lastTableCompareValues.length === lastTableLabels.length);

        const header = [
            'time' + (lastTableStepMinutes > 1 ? '_range' : ''),
            lastTableBaseLabel
        ];
        if (hasCompare) {
            header.push(lastTableCompareLabel);
        }

        const rows = [];
        rows.push(header);

        for (let i = 0; i < lastTableLabels.length; i++) {
            const row = [];
            row.push(lastTableLabels[i]);
            row.push(lastTableBaseValues[i] || 0);
            if (hasCompare) {
                row.push(lastTableCompareValues[i] || 0);
            }
            rows.push(row);
        }

        const lines = rows.map(cols =>
            cols
                .map(v => {
                    const s = String(v);
                    if (s.includes(',') || s.includes('"')) {
                        return '"' + s.replace(/"/g, '""') + '"';
                    }
                    return s;
                })
                .join(',')
        );
        const csvContent = lines.join('\r\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);

        const a = document.createElement('a');
        const now = new Date();
        const ts = now.toISOString().slice(0,19).replace(/[:T]/g, '');
        a.href = url;
        a.download = `time_bucket_rewards_${ts}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
</script>
</body>
</html>
